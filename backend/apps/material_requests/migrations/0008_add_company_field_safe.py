# Generated by Django 4.2.16 on 2025-11-14
"""
–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è company –∫ MaterialRequest.

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ company_id, –∫–æ—Ç–æ—Ä–æ–µ –¥—É–±–ª–∏—Ä—É–µ—Ç project.company
–¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–≤ 3 —ç—Ç–∞–ø–∞):
1. –î–æ–±–∞–≤–∏—Ç—å nullable —Å—Ç–æ–ª–±–µ—Ü (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ project.company –±–∞—Ç—á–∞–º–∏ (–±–µ–∑ –¥–æ–ª–≥–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
3. –î–æ–±–∞–≤–∏—Ç—å NOT NULL constraint –∏ foreign key (–±—ã—Å—Ç—Ä–æ)
"""

from django.db import migrations, models
import django.db.models.deletion


def populate_company_from_project(apps, schema_editor):
    """
    –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–µ company –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ project.company.
    """
    from django.db import connection

    with connection.cursor() as cursor:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç–æ–ª–±–µ—Ü company_id
        cursor.execute("""
            SELECT column_name
            FROM information_schema.columns
            WHERE table_name='material_requests'
            AND column_name='company_id'
        """)

        if cursor.fetchone() is None:
            print("‚ÑπÔ∏è  –°—Ç–æ–ª–±–µ—Ü 'company_id' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ")
            return

        # –ó–∞–ø–æ–ª–Ω—è–µ–º company_id –∏–∑ project.company –±–∞—Ç—á–∞–º–∏
        print("üìù –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ company_id –∏–∑ project.company...")
        cursor.execute("""
            UPDATE material_requests mr
            SET company_id = p.company_id
            FROM projects_project p
            WHERE mr.project_id = p.id
            AND mr.company_id IS NULL
        """)
        updated_rows = cursor.rowcount
        print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {updated_rows}")


def add_company_field_if_not_exists(apps, schema_editor):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ company —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
    –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.
    """
    from django.db import connection

    with connection.cursor() as cursor:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç–æ–ª–±–µ—Ü company_id
        cursor.execute("""
            SELECT column_name
            FROM information_schema.columns
            WHERE table_name='material_requests'
            AND column_name='company_id'
        """)

        if cursor.fetchone() is not None:
            print("‚ÑπÔ∏è  –°—Ç–æ–ª–±–µ—Ü 'company_id' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ")
            return

        # –°—Ç–æ–ª–±–µ—Ü –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
        print("üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ company_id...")
        cursor.execute("""
            ALTER TABLE material_requests
            ADD COLUMN company_id INTEGER NULL
            REFERENCES users_company(id)
            ON DELETE CASCADE
        """)

        # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å
        cursor.execute("""
            CREATE INDEX material_requests_company_id_idx
            ON material_requests (company_id)
        """)
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü company_id –¥–æ–±–∞–≤–ª–µ–Ω")


def make_company_not_null(apps, schema_editor):
    """
    –î–µ–ª–∞–µ—Ç –ø–æ–ª–µ company NOT NULL —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ nullable.
    """
    from django.db import connection

    with connection.cursor() as cursor:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç–æ–ª–±–µ—Ü nullable
        cursor.execute("""
            SELECT is_nullable
            FROM information_schema.columns
            WHERE table_name='material_requests'
            AND column_name='company_id'
        """)

        result = cursor.fetchone()
        if result is None:
            print("‚ö†Ô∏è  –°—Ç–æ–ª–±–µ—Ü company_id –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return

        is_nullable = result[0]
        if is_nullable == 'NO':
            print("‚ÑπÔ∏è  –°—Ç–æ–ª–±–µ—Ü company_id —É–∂–µ NOT NULL, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
            return

        # –î–µ–ª–∞–µ–º NOT NULL
        print("üìù –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NOT NULL –¥–ª—è company_id...")
        cursor.execute("""
            ALTER TABLE material_requests
            ALTER COLUMN company_id SET NOT NULL
        """)
        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü company_id —Ç–µ–ø–µ—Ä—å NOT NULL")


class Migration(migrations.Migration):

    dependencies = [
        ("material_requests", "0007_add_composite_indexes_concurrently"),
        ("users", "0001_initial"),  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –º–æ–¥–µ–ª–∏ Company
    ]

    operations = [
        # –®–ê–ì 1: –î–æ–±–∞–≤–ª—è–µ–º nullable –ø–æ–ª–µ company (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
        migrations.RunPython(
            add_company_field_if_not_exists,
            migrations.RunPython.noop
        ),

        # –®–ê–ì 2: –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ project.company
        migrations.RunPython(
            populate_company_from_project,
            migrations.RunPython.noop
        ),

        # –®–ê–ì 3: –î–µ–ª–∞–µ–º –ø–æ–ª–µ NOT NULL (–µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ nullable)
        migrations.RunPython(
            make_company_not_null,
            migrations.RunPython.noop
        ),
    ]
