# Generated by Django 4.2.16 on 2025-11-14
"""
–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è status –∫ MaterialRequestItem.

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–º–µ–Ω—è–µ—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é 0002, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞
ALTER TABLE ... ADD COLUMN ... NOT NULL, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ç–∞–±–ª–∏—Ü—ã.

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–≤ 3 —ç—Ç–∞–ø–∞):
1. –î–æ–±–∞–≤–∏—Ç—å nullable —Å—Ç–æ–ª–±–µ—Ü (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
2. –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏ (–±–µ–∑ –¥–æ–ª–≥–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
3. –î–æ–±–∞–≤–∏—Ç—å NOT NULL constraint (–±—ã—Å—Ç—Ä–æ)
"""

from django.db import migrations


def add_status_field_safe(apps, schema_editor):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è status –¥–ª—è production.
    """
    from django.db import connection

    with connection.cursor() as cursor:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç–æ–ª–±–µ—Ü status
        cursor.execute("""
            SELECT column_name
            FROM information_schema.columns
            WHERE table_name='material_request_items'
            AND column_name='status'
        """)

        if cursor.fetchone() is not None:
            print("‚ÑπÔ∏è  –°—Ç–æ–ª–±–µ—Ü 'status' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ")
            return

        # –®–ê–ì 1: –î–æ–±–∞–≤–ª—è–µ–º nullable —Å—Ç–æ–ª–±–µ—Ü (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
        print("üìù –®–∞–≥ 1/3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ nullable —Å—Ç–æ–ª–±—Ü–∞ 'status'...")
        cursor.execute("""
            ALTER TABLE material_request_items
            ADD COLUMN status VARCHAR(20) NULL
        """)

        # –®–ê–ì 2: –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞–º–∏ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        print("üìù –®–∞–≥ 2/3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –±–∞—Ç—á–∞–º–∏...")
        batch_size = 1000
        updated = 0

        while True:
            cursor.execute(f"""
                UPDATE material_request_items
                SET status = 'PENDING'
                WHERE status IS NULL
                AND id IN (
                    SELECT id FROM material_request_items
                    WHERE status IS NULL
                    LIMIT {batch_size}
                )
            """)
            rows_updated = cursor.rowcount
            updated += rows_updated
            print(f"   –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {updated}")

            if rows_updated < batch_size:
                break

        # –®–ê–ì 3: –î–æ–±–∞–≤–ª—è–µ–º NOT NULL constraint (–±—ã—Å—Ç—Ä–æ)
        print("üìù –®–∞–≥ 3/3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ NOT NULL constraint...")
        cursor.execute("""
            ALTER TABLE material_request_items
            ALTER COLUMN status SET NOT NULL
        """)

        # –®–ê–ì 4: –î–æ–±–∞–≤–ª—è–µ–º DEFAULT –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
        cursor.execute("""
            ALTER TABLE material_request_items
            ALTER COLUMN status SET DEFAULT 'PENDING'
        """)

        print("‚úÖ –°—Ç–æ–ª–±–µ—Ü 'status' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –º–µ—Ç–æ–¥–æ–º")


class Migration(migrations.Migration):

    dependencies = [
        ("material_requests", "0005_alter_materialrequest_request_number_and_more"),
    ]

    operations = [
        migrations.RunPython(add_status_field_safe, migrations.RunPython.noop),
    ]
