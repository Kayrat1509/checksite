# Generated by Django 4.2.16 on 2025-11-06 15:04

from django.db import migrations


def add_missing_buttons(apps, schema_editor):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –ø–æ–¥—Ä—è–¥—á–∏–∫–∞–º–∏ –∏ –Ω–∞–¥–∑–æ—Ä–∞–º–∏.

    –ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–æ–ª–µ–π:
    - SUPERADMIN, DIRECTOR, CHIEF_ENGINEER, PROJECT_MANAGER (—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ)
    - SITE_MANAGER (–Ω–∞—á–∞–ª—å–Ω–∏–∫ —É—á–∞—Å—Ç–∫–∞)

    –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏:
    - activate: –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–ø–æ–¥—Ä—è–¥—á–∏–∫–∞/–Ω–∞–¥–∑–æ—Ä–∞
    - deactivate: –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–ø–æ–¥—Ä—è–¥—á–∏–∫–∞/–Ω–∞–¥–∑–æ—Ä–∞
    - archive: –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ –∞—Ä—Ö–∏–≤ (–¥–ª—è contractors –∏ supervisions)
    - restore: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞ (–¥–ª—è contractors –∏ supervisions)
    - toggle_access: –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è users)
    """
    ButtonAccess = apps.get_model('core', 'ButtonAccess')

    # –†–æ–ª–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ + –Ω–∞—á–∞–ª—å–Ω–∏–∫ —É—á–∞—Å—Ç–∫–∞
    management_roles = ['SUPERADMIN', 'DIRECTOR', 'CHIEF_ENGINEER', 'PROJECT_MANAGER', 'SITE_MANAGER']

    # –°–ª–æ–≤–∞—Ä—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–Ω–æ–ø–æ–∫
    buttons_config = {
        'users': [
            {
                'button_key': 'activate',
                'button_name': '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
                'description': '–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (is_active=True)',
                'roles': management_roles
            },
            {
                'button_key': 'deactivate',
                'button_name': '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
                'description': '–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (is_active=False)',
                'roles': management_roles
            },
            {
                'button_key': 'archive',
                'button_name': '–í –∞—Ä—Ö–∏–≤',
                'description': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –∞—Ä—Ö–∏–≤',
                'roles': management_roles
            },
            {
                'button_key': 'restore',
                'button_name': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
                'description': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞',
                'roles': management_roles
            },
        ],
        'contractors': [
            {
                'button_key': 'activate',
                'button_name': '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä—è–¥—á–∏–∫–∞',
                'description': '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ (is_active=True)',
                'roles': management_roles
            },
            {
                'button_key': 'deactivate',
                'button_name': '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä—è–¥—á–∏–∫–∞',
                'description': '–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ (is_active=False)',
                'roles': management_roles
            },
            {
                'button_key': 'archive',
                'button_name': '–í –∞—Ä—Ö–∏–≤',
                'description': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ –≤ –∞—Ä—Ö–∏–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º)',
                'roles': management_roles
            },
            {
                'button_key': 'restore',
                'button_name': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
                'description': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞',
                'roles': management_roles
            },
        ],
        'supervisions': [
            {
                'button_key': 'activate',
                'button_name': '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–¥–∑–æ—Ä',
                'description': '–ê–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–¥–∑–æ—Ä–∞ (is_active=True)',
                'roles': management_roles
            },
            {
                'button_key': 'deactivate',
                'button_name': '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–¥–∑–æ—Ä',
                'description': '–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–¥–∑–æ—Ä–∞ (is_active=False)',
                'roles': management_roles
            },
            {
                'button_key': 'archive',
                'button_name': '–í –∞—Ä—Ö–∏–≤',
                'description': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –Ω–∞–¥–∑–æ—Ä–∞ –≤ –∞—Ä—Ö–∏–≤ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º)',
                'roles': management_roles
            },
            {
                'button_key': 'restore',
                'button_name': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
                'description': '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–¥–∑–æ—Ä–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞',
                'roles': management_roles
            },
        ],
    }

    # –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    for page, buttons in buttons_config.items():
        for button_config in buttons:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞
            existing = ButtonAccess.objects.filter(
                page=page,
                button_key=button_config['button_key'],
                access_type='button',
                company__isnull=True
            ).first()

            if not existing:
                # –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ä–æ–ª–µ–π
                roles_dict = {role: True for role in button_config['roles']}

                ButtonAccess.objects.create(
                    access_type='button',
                    page=page,
                    button_key=button_config['button_key'],
                    button_name=button_config['button_name'],
                    description=button_config['description'],
                    default_access=False,
                    company=None,
                    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–ª–∏
                    **roles_dict
                )
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞: {page}.{button_config['button_key']} –¥–ª—è —Ä–æ–ª–µ–π {button_config['roles']}")
            else:
                print(f"‚è≠Ô∏è  –ö–Ω–æ–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {page}.{button_config['button_key']}")


def remove_buttons(apps, schema_editor):
    """–û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ - —É–¥–∞–ª–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫."""
    ButtonAccess = apps.get_model('core', 'ButtonAccess')

    buttons_to_remove = [
        ('users', 'activate'),
        ('users', 'deactivate'),
        ('users', 'archive'),
        ('users', 'restore'),
        ('contractors', 'activate'),
        ('contractors', 'deactivate'),
        ('contractors', 'archive'),
        ('contractors', 'restore'),
        ('supervisions', 'activate'),
        ('supervisions', 'deactivate'),
        ('supervisions', 'archive'),
        ('supervisions', 'restore'),
    ]

    for page, button_key in buttons_to_remove:
        ButtonAccess.objects.filter(
            page=page,
            button_key=button_key,
            access_type='button',
            company__isnull=True
        ).delete()
        print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞: {page}.{button_key}")


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0004_simplify_buttonaccess_constraints"),
    ]

    operations = [
        migrations.RunPython(add_missing_buttons, remove_buttons),
    ]
