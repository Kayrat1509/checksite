# Generated by Django 4.2.16 on 2025-11-02 18:15

from django.db import migrations


def migrate_pageaccess_to_buttonaccess(apps, schema_editor):
    """
    –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ PageAccess –≤ ButtonAccess.

    –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏):
    1. –ë–µ—Ä–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ PageAccess
    2. –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏—Ö –¢–û–õ–¨–ö–û –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º (–ë–ï–ó –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–º–ø–∞–Ω–∏—è–º)
    3. –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–∑–¥–∞–µ–º –û–î–ù–£ –≥–ª–æ–±–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å ButtonAccess (company=NULL)
    4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    """
    PageAccess = apps.get_model('settings', 'PageAccess')
    ButtonAccess = apps.get_model('core', 'ButtonAccess')

    # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–∞–Ω–∏–∏)
    from collections import defaultdict
    pages_data = defaultdict(lambda: defaultdict(int))

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–∞–∂–¥–∞—è —Ä–æ–ª—å –∏–º–µ–ª–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    total_companies = 0
    for page_access in PageAccess.objects.all():
        page = page_access.page
        role = page_access.role
        has_access = page_access.has_access

        if has_access:
            pages_data[page][role] += 1

        # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π
        if page == 'dashboard':
            total_companies = max(total_companies, 1)

    # –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö PageAccess, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if not pages_data:
        total_companies = 1

    # –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü
    page_display_names = {
        'dashboard': '–î–∞—à–±–æ—Ä–¥',
        'projects': '–ü—Ä–æ–µ–∫—Ç—ã',
        'issues': '–ó–∞–º–µ—á–∞–Ω–∏—è',
        'users': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
        'contractors': '–ü–æ–¥—Ä—è–¥—á–∏–∫–∏',
        'supervisions': '–ù–∞–¥–∑–æ—Ä—ã',
        'material-requests': '–ó–∞—è–≤–∫–∏',
        'warehouse': '–°–∫–ª–∞–¥',
        'tenders': '–¢–µ–Ω–¥–µ—Ä—ã',
        'reports': '–û—Ç—á–µ—Ç—ã',
        'profile': '–ü—Ä–æ—Ñ–∏–ª—å',
        'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    }

    # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≤ PageAccess –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π)
    all_pages = list(page_display_names.keys())

    # –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ ButtonAccess
    created_count = 0
    for page in all_pages:
        roles_access = pages_data.get(page, {})

        # –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ PageAccess, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
        # (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –¥–æ—Å—Ç—É–ø–∞)
        default_director_access = True
        default_chief_engineer_access = True
        default_project_manager_access = True

        # –°–æ–∑–¥–∞–µ–º –û–î–ù–£ –≥–ª–æ–±–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        button_access = ButtonAccess(
            access_type='page',
            company=None,  # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π
            page=page,
            button_key='view',
            button_name=page_display_names.get(page, page.title()),
            description=f'–î–æ—Å—Ç—É–ø –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ {page_display_names.get(page, page)}',
            default_access=False,
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
            SUPERADMIN=True,
            # –ï—Å–ª–∏ –±–æ–ª—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã –∫–æ–º–ø–∞–Ω–∏–π –¥–∞–≤–∞–ª–∏ –¥–æ—Å—Ç—É–ø - –¥–∞–µ–º –¥–æ—Å—Ç—É–ø –≥–ª–æ–±–∞–ª—å–Ω–æ
            DIRECTOR=roles_access.get('DIRECTOR', 0) > (total_companies / 2) if total_companies > 0 else default_director_access,
            CHIEF_ENGINEER=roles_access.get('CHIEF_ENGINEER', 0) > (total_companies / 2) if total_companies > 0 else default_chief_engineer_access,
            PROJECT_MANAGER=roles_access.get('PROJECT_MANAGER', 0) > (total_companies / 2) if total_companies > 0 else default_project_manager_access,
            ENGINEER=roles_access.get('ENGINEER', 0) > (total_companies / 2) if total_companies > 0 else False,
            SITE_MANAGER=roles_access.get('SITE_MANAGER', 0) > (total_companies / 2) if total_companies > 0 else False,
            FOREMAN=roles_access.get('FOREMAN', 0) > (total_companies / 2) if total_companies > 0 else False,
            MASTER=roles_access.get('MASTER', 0) > (total_companies / 2) if total_companies > 0 else False,
            SUPERVISOR=roles_access.get('SUPERVISOR', 0) > (total_companies / 2) if total_companies > 0 else False,
            CONTRACTOR=roles_access.get('CONTRACTOR', 0) > (total_companies / 2) if total_companies > 0 else False,
            OBSERVER=roles_access.get('OBSERVER', 0) > (total_companies / 2) if total_companies > 0 else False,
            SUPPLY_MANAGER=roles_access.get('SUPPLY_MANAGER', 0) > (total_companies / 2) if total_companies > 0 else False,
            WAREHOUSE_HEAD=roles_access.get('WAREHOUSE_HEAD', 0) > (total_companies / 2) if total_companies > 0 else False,
            SITE_WAREHOUSE_MANAGER=roles_access.get('SITE_WAREHOUSE_MANAGER', 0) > (total_companies / 2) if total_companies > 0 else False,
        )
        button_access.save()
        created_count += 1

    print(f'‚úÖ –°–æ–∑–¥–∞–Ω–æ {created_count} –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü –≤ ButtonAccess')


def reverse_migration(apps, schema_editor):
    """
    –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ - —É–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ ButtonAccess —Å access_type='page'
    """
    ButtonAccess = apps.get_model('core', 'ButtonAccess')
    deleted_count = ButtonAccess.objects.filter(access_type='page').count()
    ButtonAccess.objects.filter(access_type='page').delete()
    print(f'üîÑ –£–¥–∞–ª–µ–Ω–æ {deleted_count} –∑–∞–ø–∏—Å–µ–π ButtonAccess —Å —Ç–∏–ø–æ–º "page"')


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0002_add_page_support_to_buttonaccess"),
        ("settings", "0004_remove_technical_conditions"),
    ]

    operations = [
        migrations.RunPython(
            migrate_pageaccess_to_buttonaccess,
            reverse_migration
        ),
    ]
