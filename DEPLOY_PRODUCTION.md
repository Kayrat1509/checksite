# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –¥–µ–ø–ª–æ—é –≤ Production

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í–Ω–µ—Å–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è "–ó–∞—è–≤–∫–∏" (Material Requests):
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Race Condition –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ –∑–∞—è–≤–æ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è state-changing –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω N+1 –ø—Ä–æ–±–ª–µ–º–∞ —á–µ—Ä–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## üéØ –ü–ª–∞–Ω –¥–µ–ø–ª–æ—è (Zero-Downtime)

### –§–ê–ó–ê 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞ (–°–†–û–ß–ù–û)

**–¶–µ–ª—å:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É admin.stroyka.asia

#### –®–∞–≥ 1.1: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ production
```bash
cd /path/to/checksite
git pull origin main  # –ü–æ–ª—É—á–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –ë–ï–ó —Å–æ—Å—Ç–∞–≤–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
systemctl restart checksite-backend  # –∏–ª–∏ docker-compose restart backend
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
curl -I https://admin.stroyka.asia/api/auth/users/me/
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 200 –∏–ª–∏ 401, –ù–ï 502
```

‚úÖ **–°–∞–π—Ç –¥–æ–ª–∂–µ–Ω –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞!**

---

### –§–ê–ó–ê 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π (–ë–ï–ó DOWNTIME)

**–¶–µ–ª—å:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –®–∞–≥ 2.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
cd /path/to/checksite/backend
python manage.py showmigrations material_requests
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
material_requests
 [X] 0001_initial
 [X] 0002_add_status_to_material_request_item
 [X] 0003_add_history_actions
 [X] 0004_materialrequestitem_received_at
 [X] 0005_alter_materialrequest_request_number_and_more
 [ ] 0006_safe_add_status_field
 [ ] 0007_add_composite_indexes_concurrently
```

#### –®–∞–≥ 2.2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 0006 (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ status)
```bash
# –≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–æ–ª–±–µ—Ü status –±–∞—Ç—á–∞–º–∏ (–±–µ–∑ –¥–æ–ª–≥–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
python manage.py migrate material_requests 0006

# –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–≤–µ–¥–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å:
# üìù –®–∞–≥ 1/3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ nullable —Å—Ç–æ–ª–±—Ü–∞ 'status'...
# üìù –®–∞–≥ 2/3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –±–∞—Ç—á–∞–º–∏...
#    –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: 1000
#    –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: 2000
# üìù –®–∞–≥ 3/3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ NOT NULL constraint...
# ‚úÖ –°—Ç–æ–ª–±–µ—Ü 'status' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –º–µ—Ç–æ–¥–æ–º
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~30 —Å–µ–∫—É–Ω–¥ –Ω–∞ 100,000 –∑–∞–ø–∏—Å–µ–π (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!)

#### –®–∞–≥ 2.3: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 0007 (—Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã CONCURRENTLY)
```bash
# –í–ê–ñ–ù–û: –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å CONCURRENTLY - –ë–ï–ó –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã!
python manage.py migrate material_requests 0007
```

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 1-5 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
**–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞:** –ù–ï–¢ (—Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤)

#### –®–∞–≥ 2.4: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ models.py

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ production –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª:**
```bash
nano backend/apps/material_requests/models.py
```

–ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∞ ~210):
```python
# –°–û–°–¢–ê–í–ù–´–ï –ò–ù–î–ï–ö–°–´ –ë–£–î–£–¢ –î–û–ë–ê–í–õ–ï–ù–´ –ü–û–°–õ–ï –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –ú–ò–ì–†–ê–¶–ò–ò 0007
# –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å production
# TODO: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ: python manage.py migrate material_requests 0007
# models.Index(fields=['company', 'status', 'is_deleted'], name='idx_company_status_deleted'),
# models.Index(fields=['company', 'current_approval_role'], name='idx_company_approval_role'),
# models.Index(fields=['project', 'status'], name='idx_project_status'),
# models.Index(fields=['author', '-created_at'], name='idx_author_created'),
```

**–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:**
```python
# –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ + —Å—Ç–∞—Ç—É—Å—É + soft delete (–æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä –≤ ViewSet)
models.Index(fields=['company', 'status', 'is_deleted'], name='idx_company_status_deleted'),

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ + —Ä–æ–ª–∏ —Å–æ–≥–ª–∞—Å—É—é—â–µ–≥–æ (–¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏")
models.Index(fields=['company', 'current_approval_role'], name='idx_company_approval_role'),

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–æ–µ–∫—Ç—É + —Å—Ç–∞—Ç—É—Å—É (–¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ø—Ä–æ–µ–∫—Ç—É)
models.Index(fields=['project', 'status'], name='idx_project_status'),

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–≤—Ç–æ—Ä—É + –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–ú–æ–∏ –∑–∞—è–≤–∫–∏")
models.Index(fields=['author', '-created_at'], name='idx_author_created'),
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ:
```bash
systemctl restart checksite-backend
```

---

### –§–ê–ó–ê 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### –®–∞–≥ 3.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É API
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
curl -I https://admin.stroyka.asia/api/auth/users/me/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞—è–≤–æ–∫ (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–æ —Å –∫—ç—à–µ–º)
curl https://admin.stroyka.asia/api/material-requests/statistics/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### –®–∞–≥ 3.2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
```bash
psql checksite_db -c "
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'material_requests'
AND indexname LIKE 'idx_%';
"
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
           indexname           |                         indexdef
-------------------------------+----------------------------------------------------------
idx_company_status_deleted    | CREATE INDEX ... ON material_requests (company_id, status, is_deleted)
idx_company_approval_role     | CREATE INDEX ... ON material_requests (company_id, current_approval_role)
idx_project_status            | CREATE INDEX ... ON material_requests (project_id, status)
idx_author_created            | CREATE INDEX ... ON material_requests (author_id, created_at DESC)
```

#### –®–∞–≥ 3.3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (—á–µ—Ä–µ–∑ 1-2 –¥–Ω—è)
psql checksite_db -c "
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read
FROM pg_stat_user_indexes
WHERE tablename = 'material_requests'
AND indexname LIKE 'idx_%'
ORDER BY idx_scan DESC;
"
```

---

## üîß –û—Ç–∫–∞—Ç –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ 0007 (–∏–Ω–¥–µ–∫—Å—ã)
```bash
python manage.py migrate material_requests 0006
# –í–µ—Ä–Ω—É—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ models.py
systemctl restart checksite-backend
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ 0006 (—Å—Ç–æ–ª–±–µ—Ü status)
```bash
python manage.py migrate material_requests 0005
systemctl restart checksite-backend
```

### –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
```bash
git revert HEAD~3..HEAD  # –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∫–æ–º–º–∏—Ç–∞
systemctl restart checksite-backend
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| **Race condition —Ä–∏—Å–∫** | üî¥ –í—ã—Å–æ–∫–∏–π | ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | 100% |
| **SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ 100 –∑–∞—è–≤–æ–∫** | üî¥ ~700 | ‚úÖ ~10 | 98% ‚Üì |
| **–ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** | üî¥ 8 –∫–∞–∂–¥—ã–π —Ä–∞–∑ | ‚úÖ 1 —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É | 87% ‚Üì |
| **–°–∫–æ—Ä–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞—è–≤–æ–∫** | üü° –°—Ä–µ–¥–Ω—è—è | ‚úÖ –í—ã—Å–æ–∫–∞—è | 2-3x ‚Üë |

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ staging**
2. **–í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–π—Ç–µ backup –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:**
   ```bash
   pg_dump checksite_db > backup_$(date +%Y%m%d_%H%M%S).sql
   ```
3. **–ú–∏–≥—Ä–∞—Ü–∏–∏ 0006 –∏ 0007 –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü** (–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ 100k+ –∑–∞–ø–∏—Å–µ–π)
4. **CONCURRENTLY –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –ë–ï–ó –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**, —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è

---

## üÜò –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f /var/log/checksite/backend.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ PostgreSQL: `tail -f /var/log/postgresql/postgresql-15-main.log`
3. –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è

- [ ] –°–æ–∑–¥–∞–Ω backup –ë–î
- [ ] –§–ê–ó–ê 1: –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω, —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (502 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
- [ ] –§–ê–ó–ê 2.2: –ú–∏–≥—Ä–∞—Ü–∏—è 0006 –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] –§–ê–ó–ê 2.3: –ú–∏–≥—Ä–∞—Ü–∏—è 0007 –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] –§–ê–ó–ê 2.4: –ò–Ω–¥–µ–∫—Å—ã —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ models.py
- [ ] –§–ê–ó–ê 3: –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–î–∞—Ç–∞ –¥–µ–ø–ª–æ—è:** ___________
**–í—ã–ø–æ–ª–Ω–∏–ª:** ___________
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ___________
