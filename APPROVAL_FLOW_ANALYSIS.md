# –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó –°–ò–°–¢–ï–ú–´ –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø –ó–ê–Ø–í–û–ö (Material Requests Approval Flow)

## –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 1: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ë–î –º–æ–¥–µ–ª—è—Ö - company field (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í models.py —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –∫–æ–º–ø–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ project.company:
- –°—Ç—Ä–æ–∫–∞ 84: `# –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É (–∫–æ–º–ø–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ project.company)`

**–û–î–ù–ê–ö–æ –≤ views.py –∏ serializers.py –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ MaterialRequest.company:**

Views.py:
- –°—Ç—Ä–æ–∫–∞ 73: `company=user.company` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- –°—Ç—Ä–æ–∫–∞ 96: `'company',` - –≤ prefetch_related
- –°—Ç—Ä–æ–∫–∞ 558: `MaterialRequest.objects.filter(company=company, is_deleted=False)` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ company

Serializers.py:
- –°—Ç—Ä–æ–∫–∞ 132: `company_name = serializers.CharField(source='company.name', read_only=True)` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ company
- –°—Ç—Ä–æ–∫–∞ 227: `'company',` - –≤ fields
- –°—Ç—Ä–æ–∫–∞ 296: `company=user.company if user else None` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

**–í –º–∏–≥—Ä–∞—Ü–∏–∏ 0001_initial.py (—Å—Ç—Ä–æ–∫–∏ 171-178):**
```python
"company",
models.ForeignKey(
    help_text="–ö–æ–º–ø–∞–Ω–∏—è, —Å–æ–∑–¥–∞–≤—à–∞—è –∑–∞—è–≤–∫—É",
    on_delete=django.db.models.deletion.CASCADE,
    related_name="material_requests",
    to="users.company",
    verbose_name="–ö–æ–º–ø–∞–Ω–∏—è",
),
```

**–í–´–í–û–î:** –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ models.py, –≤ –ë–î –ï–°–¢–¨ –ø–æ–ª–µ company (—Å–æ–∑–¥–∞–Ω–æ –≤ 0001_initial), –∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ!

**–†–ò–°–ö –¥–ª—è PRODUCTION:**
- –ï—Å–ª–∏ –≤ production –ë–î –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ (—É–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ company), —Ç–æ views.py —Å—Ç—Ä–æ–∫–∞ 558 –∏ serializers.py —Å—Ç—Ä–æ–∫–∞ 132 –≤—ã–∑–æ–≤—É—Ç –æ—à–∏–±–∫—É
- Query `MaterialRequest.objects.filter(company=user.company)` –≤—ã–∑–æ–≤–µ—Ç AttributeError


### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 2: Race Condition –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** models.py, –º–µ—Ç–æ–¥—ã `save()` (207-215) –∏ `generate_request_number()` (217-250)

**–û–ø–∏—Å–∞–Ω–∏–µ:** 
- –°—Ç—Ä–æ–∫–∞ 233-236: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `select_for_update()` —Å `aggregate(Max('request_number'))`
- select_for_update() –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏, –Ω–æ aggregate –ü–û–°–õ–ï –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –°—Ç—Ä–æ–∫–∞ 234-236
last_request = MaterialRequest.objects.filter(
    project__company=self.project.company
).select_for_update().aggregate(Max('request_number'))
```

select_for_update() –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≠–•–û rows, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Å–ª–æ–≤–∏—é filter(). –ï—Å–ª–∏ filter() –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω—É–ª (–ø–µ—Ä–≤–∞—è –∑–∞—è–≤–∫–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏), –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–æ–æ–±—â–µ –Ω–µ –±—É–¥–µ—Ç!

**–†–ò–°–ö:**
–ù–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö POST –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞—è–≤–∫–µ –ø—Ä–∏–≤–µ–¥—É—Ç –∫:
- race condition –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ next_number
- –û–±–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—É—á–∞—Ç –Ω–æ–º–µ—Ä '01012025-1'
- Unique constraint –≤ –ë–î –Ω–µ —Å–ø–∞—Å–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –∏–Ω–¥–µ–∫—Å –Ω–∞ (company_id, request_number), –Ω–æ company –º–æ–∂–µ—Ç –±—ã—Ç—å NULL


### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 3: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** models.py, –º–µ—Ç–æ–¥ `get_company_available_roles()` (350-370)

**–ö–æ–¥:**
```python
def get_company_available_roles(self):
    company_id = self.project.company_id
    cache_key = f'company_available_roles_{company_id}'
    available_roles = cache.get(cache_key)
    
    if available_roles is None:
        available_roles = set(
            User.objects.filter(company_id=company_id, is_active=True)
            .values_list('role', flat=True)
            .distinct()
        )
        cache.set(cache_key, available_roles, timeout=300)  # 5 –º–∏–Ω—É—Ç
    return available_roles
```

**–†–ò–°–ö:**
- –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –Ω–æ–≤—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–º–ø–∞–Ω–∏—é —Å —Ä–æ–ª—å—é, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞–Ω—å—à–µ –Ω–µ –±—ã–ª–∞ - –∑–∞—è–≤–∫–∞ –ù–ï –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫ —ç—Ç–æ–π —Ä–æ–ª–∏ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∫—ç—à–∞ (5 –º–∏–Ω—É—Ç)
- –í production –º–æ–∂–µ—Ç –±—ã—Ç—å –û–ß–ï–ù–¨ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –º–µ–∂–¥—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ–º
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ö—ç—à –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–º–Ω–æ–≥–æ –∫–æ—Ä–æ—á–µ (60-120 —Å–µ–∫—É–Ω–¥) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å signal –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏


### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 4: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ permissions –≤ approve() –∏ reject() (–í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** views.py, –º–µ—Ç–æ–¥—ã `approve()` (203-255) –∏ `reject()` (258-288)

**approve() —Å—Ç—Ä–æ–∫–∏ 217-223:**
```python
if material_request.current_approval_role != user_role:
    return Response(
        {
            'error': f'–°–µ–π—á–∞—Å –∑–∞—è–≤–∫–∞ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏: {material_request.current_approval_role}'
        },
        status=status.HTTP_403_FORBIDDEN
    )
```

**–ü–†–û–ë–õ–ï–ú–ê:**
–ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–û–õ–¨–ö–û –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å current_approval_role. –ù–û:
- –ï—Å–ª–∏ –≤ –∫–æ–º–ø–∞–Ω–∏–∏ 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—å—é ENGINEER, –û–ë–ê —Å–º–æ–≥—É—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å (—ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –ù–û –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –≤ —Ç–æ—Ç –∂–µ –ø—Ä–æ–µ–∫—Ç!

**–†–ò–°–ö:**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –ü—Ä–æ–µ–∫—Ç–∞ A —Å —Ä–æ–ª—å—é ENGINEER –º–æ–∂–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É –∏–∑ –ü—Ä–æ–µ–∫—Ç–∞ B, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –æ–¥–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏!

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É:
```python
if material_request.project not in request.user.projects.all() and request.user.role not in management_roles:
    return 403
```


### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 5: –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ queryset –≤ views –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞—è (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** views.py, –º–µ—Ç–æ–¥ `get_queryset()` (60-160)

**–°—Ç—Ä–æ–∫–∏ 72-75:**
```python
queryset = MaterialRequest.objects.filter(
    company=user.company,  # –ü–†–û–í–ï–†–Ø–ï–¢ company!
    is_deleted=False
)
```

**–ù–û –≤ admin.py (256-290) —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –û–¢–õ–ò–ß–ê–ï–¢–°–Ø:**
```python
def get_queryset(self, request):
    queryset = super().get_queryset(request).select_related(
        'author',
        'project',
        'project__company',  # –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø project__company!
        'rejected_by'
    )
```

**–†–ò–°–ö:**
- –ï—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç company field –≤ production, views.py —É–ø–∞–¥–µ—Ç –Ω–∞ "company=user.company"
- admin.py –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ project__company
- –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –º–µ–∂–¥—É API –∏ Admin


### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 6: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞—è "—Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ—Ç –≤ –±–∞–∑–µ" (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** views.py, `approve()` —Å—Ç—Ä–æ–∫–∏ 225-238

```python
approval_step = ApprovalStep.objects.filter(
    material_request=material_request,
    role=user_role,
    status=ApprovalStep.STATUS_APPROVED
).order_by('-approved_at').first()  # <-- –ú–û–ñ–ï–¢ –ë–´–¢–¨ None!

if approval_step:  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å
    approval_step.comment = comment
    approval_step.save()
```

**–†–ò–°–ö:** –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ ApprovalStep –Ω–µ —Å–æ–∑–¥–∞–Ω–∞, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –Ω–æ –º–æ–ª—á–∞–ª–∏–≤—ã–π –æ—Ç–∫–∞–∑.


### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê 7: statistics endpoint –Ω–µ–ø–æ–ª–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** views.py, –º–µ—Ç–æ–¥ `statistics()` (535-587)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç –∑–∞—è–≤–∫–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É, –Ω–æ:
- –°—Ç—Ä–æ–∫–∞ 580: `'completed': base_queryset.filter(status=MaterialRequest.STATUS_COMPLETED).count()`
- –ù–û –≤ get_queryset() –¥–ª—è 'completed' –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Subquery —Å Exists (—Å—Ç—Ä–æ–∫–∏ 128-133)!

–≠—Ç–æ —Ä–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã:
```python
# –í statistics: –ø—Ä–æ—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä –ø–æ STATUS_COMPLETED
'completed': base_queryset.filter(status=MaterialRequest.STATUS_COMPLETED).count()

# –í get_queryset(): —Ñ–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ª–∏—á–∏—é RECEIVED items
has_received_items = MaterialRequestItem.objects.filter(
    material_request=OuterRef('pk'),
    status=MaterialRequestItem.STATUS_RECEIVED
)
queryset = queryset.filter(Exists(has_received_items))
```

**–†–ò–°–ö:** –°—á–µ—Ç—á–∏–∫ –≤ statistics –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–Ω–æ–µ —á–∏—Å–ª–æ, —á–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –≤ completed –≤–∫–ª–∞–¥–∫–µ


## –ü–†–û–ë–õ–ï–ú–´ –° –ú–ò–ì–†–ê–¶–ò–Ø–ú–ò

### ‚ö†Ô∏è –ú–ò–ì–†–ê–¶–ò–Ø 0005 - –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ constraint (–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** migrations/0005_alter_materialrequest_request_number_and_more.py

**–°—Ç—Ä–æ–∫–∏ 15-47:**
```python
def add_constraint_if_not_exists(apps, schema_editor):
    # ...
    table_name = 'material_requests_materialrequest'  # <-- –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ï –ò–ú–Ø!
```

**–ü–†–û–ë–õ–ï–ú–ê:**
–ö–∞–∫ Django convention, —Ç–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å `material_requests_materialrequest`, –Ω–æ –ú–û–ñ–ï–¢ –±—ã—Ç—å `material_requests` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —á–µ—Ä–µ–∑ Meta.db_table!

–í models.py (—Å—Ç—Ä–æ–∫–∞ 182): `db_table = 'material_requests'`

**–í–´–í–û–î:** Constraint –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å—Å—è –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ `material_requests_materialrequest`, –∫–æ–≥–¥–∞ —Ä–µ–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ - `material_requests`!

**–†–ò–°–ö –¥–ª—è PRODUCTION:**
- Constraint –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–±–∞–≤–∏—Ç—Å—è!
- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–≤–µ –∑–∞—è–≤–∫–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º request_number –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö
- –ú–∏–≥—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç "—É—Å–ø–µ—à–Ω–æ–π", –Ω–æ constraint –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å


### ‚ö†Ô∏è –ú–ò–ì–†–ê–¶–ò–Ø 0006 - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢)

**–§–∞–π–ª:** migrations/0006_safe_add_status_field.py

–ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç batch update, –Ω–æ:
- –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ç–∞–±–ª–∏—Ü–∞ material_request_items
- –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ previous migrations, –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–¥–µ—Ç —Å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π


### ‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø 0007 - –•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞

**–§–∞–π–ª:** migrations/0007_add_composite_indexes_concurrently.py

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CONCURRENTLY –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ - –æ—Ç–ª–∏—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è production


## –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –í PRODUCTION

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Company field –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

**–ï—Å–ª–∏ –≤ production –±—ã–ª —É–¥–∞–ª–µ–Ω company field –∏–∑ –º–æ–¥–µ–ª–∏:**

views.py —Å—Ç—Ä–æ–∫–∞ 558:
```python
base_queryset = MaterialRequest.objects.filter(company=company, is_deleted=False)
# FieldError: Cannot resolve keyword 'company' into field
```

serializers.py —Å—Ç—Ä–æ–∫–∞ 132:
```python
company_name = serializers.CharField(source='company.name', read_only=True)
# FieldError: Cannot resolve keyword 'company.name' into field
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `project__company` –≤–µ–∑–¥–µ –≤–º–µ—Å—Ç–æ `company`


### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ò–Ω–¥–µ–∫—Å—ã –≤ production –Ω–µ —Å–æ–∑–¥–∞–Ω—ã

**–ú–∏–≥—Ä–∞—Ü–∏—è 0007** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CONCURRENTLY, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –≤ models.py (—Å—Ç—Ä–æ–∫–∏ 189-202) –∏–Ω–¥–µ–∫—Å—ã –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–´:

```python
indexes = [
    models.Index(fields=['request_number']),
    models.Index(fields=['status']),
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ ...
    # –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL —Å CONCURRENTLY (—Å–º. DEPLOY_PRODUCTION.md)
]
```

**–†–ò–°–ö:** –ï—Å–ª–∏ –≤ production –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ 0007, queries –±—É–¥—É—Ç –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏


### –ü—Ä–æ–±–ª–µ–º–∞ 3: Unique constraint –Ω–∞ request_number –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å

**–ú–∏–≥—Ä–∞—Ü–∏—è 0005** –ø—ã—Ç–∞–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:
```python
UNIQUE (company_id, request_number)
```

–ù–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å:
- –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å duplicate request_number –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏
- –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º


## –û–¢–°–£–¢–°–¢–í–£–Æ–©–ò–ï –ü–†–û–í–ï–†–ö–ò

### 1. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ first approval role

–í `submit_for_approval()` (252-278):
```python
first_role = self.get_first_approval_role()
```

–ï—Å–ª–∏ `get_first_approval_role()` –≤–µ—Ä–Ω—É–ª —Ä–æ–ª—å, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç?

–°—Ç—Ä–æ–∫–∞ 267-278:
```python
with transaction.atomic():
    self.status = self.STATUS_IN_APPROVAL
    self.current_approval_role = first_role  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ä–æ–ª—å!
    self.submitted_at = timezone.now()
    self.save()
    
    ApprovalStep.objects.create(
        material_request=self,
        role=first_role,  # –°–æ–∑–¥–∞—Å—Ç ApprovalStep —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–æ–ª—å—é!
        status=ApprovalStep.STATUS_PENDING
    )
```

**–†–ò–°–ö:** –ï—Å–ª–∏ –≤ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç –Ω–∏ –ù–∞—á–∞–ª—å–Ω–∏–∫–∞ —É—á–∞—Å—Ç–∫–∞, –Ω–∏ –ò–Ω–∂–µ–Ω–µ—Ä–∞ –ü–¢–û, –∑–∞—è–≤–∫–∞ –∑–∞–≤–∏—Å–Ω–µ—Ç –Ω–∞ —Å—Ç–∞—Ç—É—Å–µ IN_APPROVAL —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–æ–ª—å—é!


### 2. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

–¢–µ–∫—É—â–∞—è —Ü–µ–ø–æ—á–∫–∞ (models.py, 382-390):
```python
approval_chain = [
    'MASTER',
    'FOREMAN',
    'SITE_MANAGER',
    'ENGINEER',
    'PROJECT_MANAGER',
    'CHIEF_ENGINEER',
    'DIRECTOR',
]
```

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç —ç—Ç—É —Ü–µ–ø–æ—á–∫—É –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∫–æ–¥ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é —Ä–æ–ª—å –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ


### 3. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ NULL –≤ author

`approve_by_role()` (296-348) –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ author –Ω–µ NULL

`get_first_approval_role()` (280-294) –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `self.author.role` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏:
```python
if self.author.role in ['MASTER', 'FOREMAN']:  # <-- –ï—Å–ª–∏ author=NULL, —É–ø–∞–¥–µ—Ç!
```


## –ü–†–û–ë–õ–ï–ú–´ –° –ö–≠–®–ò–†–û–í–ê–ù–ò–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ statistics() (545-551)

```python
cache_key = f'material_request_stats_{company.id}_{user.id}'
```

–ö—ç—à –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ user.id, –Ω–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏—Ç —Ä–æ–ª—å, –∫—ç—à –Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è!

**–†–ò–°–ö:** –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—Å–µ –µ—â–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ —Å—Ç–∞—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥


## RISK ASSESSMENT (–°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –†–ò–°–ö–û–í)

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤ PROD | –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ | –†–µ—à–µ–Ω–∏–µ |
|----|----------|-----------|-------------------|------------|---------|
| 1 | Company field –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ | üî¥ –í–´–°–û–ö–ò–ô | –°—Ä–µ–¥–Ω—è—è | –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ views/serializers | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ company –≤ –ë–î, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å project__company –≤–µ–∑–¥–µ |
| 2 | Race condition –≤ –Ω–æ–º–µ—Ä–µ –∑–∞—è–≤–∫–∏ | üî¥ –í–´–°–û–ö–ò–ô | –ù–∏–∑–∫–∞—è | Duplicate request_number | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å select_for_update() —Å –ø—É—Å—Ç—ã–º filter() |
| 3 | –ö—ç—à –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π | üü† –°–†–ï–î–ù–ò–ô | –í—ã—Å–æ–∫–∞—è | –ó–∞—è–≤–∫–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω—É–∂–Ω—ã–º –ª—é–¥—è–º | –°–æ–∫—Ä–∞—Ç–∏—Ç—å timeout –¥–æ 60 —Å–µ–∫ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å signal –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é |
| 4 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ project –ø—Ä–∏ approve | üî¥ –í–´–°–û–ö–ò–ô | –°—Ä–µ–¥–Ω—è—è | –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏ | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É project –¥–æ—Å—Ç—É–ø–∞ |
| 5 | –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è queryset | üî¥ –í–´–°–û–ö–ò–ô | –í—ã—Å–æ–∫–∞—è | API –∏ Admin —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ-—Ä–∞–∑–Ω–æ–º—É | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ project__company |
| 6 | –ú–∏–≥—Ä–∞—Ü–∏—è 0005 —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º —Ç–∞–±–ª–∏—Ü—ã | üî¥ –í–´–°–û–ö–ò–ô | –í—ã—Å–æ–∫–∞—è | Constraint –Ω–µ –¥–æ–±–∞–≤–∏—Ç—Å—è, dupes –≤–æ–∑–º–æ–∂–Ω—ã | –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ |
| 7 | Statistics –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å filtered list | üü† –°–†–ï–î–ù–ò–ô | –°—Ä–µ–¥–Ω—è—è | UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ |
| 8 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è first_role | üü† –°–†–ï–î–ù–ò–ô | –°—Ä–µ–¥–Ω—è—è | –ó–∞—è–≤–∫–∞ –∑–∞–≤–∏—Å–Ω–µ—Ç –Ω–∞ IN_APPROVAL | –î–æ–±–∞–≤–∏—Ç—å fallback –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É |
| 9 | author –º–æ–∂–µ—Ç –±—ã—Ç—å NULL | üü† –°–†–ï–î–ù–ò–ô | –ù–∏–∑–∫–∞—è | AttributeError –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ first_role | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ NULL |
| 10 | –ù–µ—Ç –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ä–æ–ª–∏ | üü° –ù–ò–ó–ö–ò–ô | –°—Ä–µ–¥–Ω—è—è | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ 60 —Å–µ–∫ | –î–æ–±–∞–≤–∏—Ç—å signal –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ |

---

## –§–ê–ô–õ–´ –°–ò–°–¢–ï–ú–´ –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø

### Backend

1. **Models** `/backend/apps/material_requests/models.py` (825 —Å—Ç—Ä–æ–∫)
   - MaterialRequest (–∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞—è–≤–∫–∏)
   - MaterialRequestItem (–ø–æ–∑–∏—Ü–∏—è –∑–∞—è–≤–∫–∏)
   - ApprovalStep (—ç—Ç–∞–ø —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è)
   - MaterialRequestHistory (–∏—Å—Ç–æ—Ä–∏—è)

2. **Views** `/backend/apps/material_requests/views.py` (588 —Å—Ç—Ä–æ–∫)
   - MaterialRequestViewSet
   - Actions: submit, approve, reject, mark_payment, mark_paid, mark_received
   - Filtering logic –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫

3. **Serializers** `/backend/apps/material_requests/serializers.py` (491 —Å—Ç—Ä–æ–∫)
   - MaterialRequestListSerializer
   - MaterialRequestDetailSerializer
   - MaterialRequestCreateSerializer
   - ApprovalStepSerializer

4. **Admin** `/backend/apps/material_requests/admin.py` (541 —Å—Ç—Ä–æ–∫)
   - MaterialRequestAdmin
   - MaterialRequestItemAdmin
   - ApprovalStepAdmin
   - MaterialRequestHistoryAdmin

5. **URLs** `/backend/apps/material_requests/urls.py` (17 —Å—Ç—Ä–æ–∫)
   - Router –¥–ª—è API endpoints

6. **Migrations** (7 —Ñ–∞–π–ª–æ–≤)
   - 0001_initial.py - —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
   - 0002_add_status_to_material_request_item.py
   - 0003_add_history_actions.py
   - 0004_materialrequestitem_received_at.py
   - 0005_alter_materialrequest_request_number_and_more.py (–ü–†–û–ë–õ–ï–ú–ê —Å —Ç–∞–±–ª–∏—Ü–µ–π!)
   - 0006_safe_add_status_field.py (–±–∞—Ç—á update —Å –ü–†–û–í–ï–†–ö–û–ô)
   - 0007_add_composite_indexes_concurrently.py (CONCURRENTLY –∏–Ω–¥–µ–∫—Å—ã)

### Frontend

1. `/frontend/src/api/materialRequests.ts` - API –∫–ª–∏–µ–Ω—Ç
2. `/frontend/src/pages/MaterialRequests.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞—è–≤–æ–∫
3. `/frontend/backups/MaterialRequests.tsx.backup` - —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. `/MATERIAL_REQUESTS_LOGIC.md` - –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞ (421 —Å—Ç—Ä–æ–∫–∞)
2. `/MATERIAL_REQUESTS_UI_SPEC.md` - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è UI

---

## –¢–ï–ö–£–©–ê–Ø –õ–û–ì–ò–ö–ê –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```
DRAFT (—Å–æ–∑–¥–∞–Ω–∏–µ)
  ‚Üì
(submit) ‚Üí IN_APPROVAL (–ø–µ—Ä–≤—ã–π —à–∞–≥ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è)
  ‚Üì
–¶–µ–ø–æ—á–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è (—Ç–µ–∫—É—â–∞—è: SITE_MANAGER ‚Üí ENGINEER ‚Üí PROJECT_MANAGER ‚Üí CHIEF_ENGINEER ‚Üí DIRECTOR)
  ‚Üì
APPROVED (—Å–Ω–∞–±–∂–µ–Ω–µ—Ü –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
  ‚Üì
IN_PAYMENT ‚Üí IN_DELIVERY ‚Üí COMPLETED
  ‚Üì
–∏–ª–∏ REJECTED (–≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç) ‚Üê –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ DRAFT
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏

Format: `–î–î–ú–ú–ì–ì–ì–ì-‚Ññ` (–ø—Ä–∏–º–µ—Ä: `12112025-1`)
- –£–Ω–∏–∫–∞–ª–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏ (—Ö–æ—Ç—è constraint –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å!)
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `save()` —á–µ—Ä–µ–∑ `select_for_update()`
- SELECT_FOR_UPDATE –º–æ–∂–µ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö records

### –¶–µ–ø–æ—á–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è

```python
['MASTER', 'FOREMAN', 'SITE_MANAGER', 'ENGINEER', 'PROJECT_MANAGER', 'CHIEF_ENGINEER', 'DIRECTOR']
```

–ü—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ–º–ø–∞–Ω–∏–∏

---

## –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### –ü–†–ò–û–†–ò–¢–ï–¢ 1 - –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è PRODUCTION:

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 0005** - –∏–∑–º–µ–Ω–∏—Ç—å –∏–º—è —Ç–∞–±–ª–∏—Ü—ã —Å `material_requests_materialrequest` –Ω–∞ `material_requests`
2. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ company** - –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `project__company` –≤–º–µ—Å—Ç–æ `company`
3. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É project –¥–æ—Å—Ç—É–ø–∞ –≤ approve()** –∏ `reject()`
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ first_role –≤ submit_for_approval()** - –¥–æ–±–∞–≤–∏—Ç—å fallback

### –ü–†–ò–û–†–ò–¢–ï–¢ 2 - –í–ê–ñ–ù–û:

5. –°–æ–∫—Ä–∞—Ç–∏—Ç—å timeout –∫—ç—à–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π —Å 300 –¥–æ 60 —Å–µ–∫
6. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ statistics —Å get_queryset()
7. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É author!=NULL –≤ get_first_approval_role()
8. –î–æ–±–∞–≤–∏—Ç—å signal –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü–†–ò–û–†–ò–¢–ï–¢ 3 - NICE TO HAVE:

9. –î–æ–±–∞–≤–∏—Ç—å explicit –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ ApprovalStep –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
10. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è race condition —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
11. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ approval flow

