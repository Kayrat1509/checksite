# ๐ ะะพะฒะฐั ะปะพะณะธะบะฐ ัะพะณะปะฐัะพะฒะฐะฝะธั ะทะฐัะฒะพะบ ะธ ะฟะพะทะธัะธะน โ ะะฝะฐะปะธะท ะธ ัะตะบะพะผะตะฝะดะฐัะธะธ

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-11-09
**ะกัะฐััั:** ะัะตะดะปะพะถะตะฝะธะต ะบ ะพะฑััะถะดะตะฝะธั
**ะัะธะพัะธัะตั:** ะััะพะบะธะน

---

## ๐ ะขัะตะฑะพะฒะฐะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั

### ะขะตะบััะฐั ะฟัะพะฑะปะตะผะฐ:
ะะพัะปะต ัะพะณะปะฐัะพะฒะฐะฝะธั ะะธัะตะบัะพัะฐ ะฟะพะทะธัะธั ะฟะตัะตัะพะดะธั ะฒ ััะฐััั `BACK_TO_SUPPLY_AFTER_DIRECTOR`, ะธ ะกะฝะฐะฑะถะตะฝะตั ะผะพะถะตั ะพัะฟัะฐะฒะธัั ะตั ะฝะฐ ะพะฟะปะฐัั. ะะดะฝะฐะบะพ:

1. **ะััััััะฒัะตั ัะธะปัััะฐัะธั ะฟะพ ััะฐัััะฐะผ** โ ะฝะตั ะพัะดะตะปัะฝะพะณะพ ัะฐะทะดะตะปะฐ "ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ"
2. **ะะตั ะบะพะฝััะพะปั ะฟะพ ัะฐะบัั** โ ะฟะพะทะธัะธั ะผะพะถะตั ะทะฐะฒะตััะธัััั ะดะฐะถะต ะตัะปะธ `actual_quantity < quantity`
3. **ะกะผะตัะฐะฝั ัะพะปะธ** โ ะบะฝะพะฟะบะฐ "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต" ะดะพัััะฟะฝะฐ ัะปะธัะบะพะผ ัะธัะพะบะพะผั ะบััะณั ัะพะปะตะน
4. **ะะตั ัะตัะบะพะณะพ ัะฐะทะดะตะปะตะฝะธั workflow** โ ะทะฐะบัะฟะบะฐ ัะตัะตะท ะพะฟะปะฐัั ะธ ะฟะพะปััะตะฝะธะต ัะพ ัะบะปะฐะดะฐ ะธะดัั ัะฐะทะฝัะผะธ ะฟัััะผะธ, ะฝะพ ะธะฝัะตััะตะนั ััะพ ะฝะต ะพััะฐะถะฐะตั

---

## ๐ฏ ะะพะฒัะต ััะตะฑะพะฒะฐะฝะธั:

### 1. ะคะธะปัััะฐัะธั ะทะฐัะฒะพะบ ะฟะพ ััะฐัััะฐะผ

**ะขัะธ ะพัะฝะพะฒะฝัั ัะฐะทะดะตะปะฐ:**

| ะะฐะทะดะตะป | ะฃัะปะพะฒะธะต ัะธะปัััะฐัะธะธ | ะะฟะธัะฐะฝะธะต |
|--------|-------------------|----------|
| **ะะฐ ัะพะณะปะฐัะพะฒะฐะฝะธะธ** | `item_status` ะฒ `[UNDER_REVIEW, WAREHOUSE_CHECK, BACK_TO_SUPPLY, ENGINEER_APPROVAL, BACK_TO_SUPPLY_AFTER_ENGINEER, PROJECT_MANAGER_APPROVAL, BACK_TO_SUPPLY_AFTER_PM, DIRECTOR_APPROVAL, RETURNED_FOR_REVISION]` | ะะพะทะธัะธะธ, ะฟัะพัะพะดััะธะต ัะตะฟะพัะบั ัะพะณะปะฐัะพะฒะฐะฝะธั |
| **ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ** | `item_status` ะฒ `[BACK_TO_SUPPLY_AFTER_DIRECTOR, APPROVED, PAYMENT, PAID, DELIVERY]` + `actual_quantity < quantity` | ะะพะทะธัะธะธ ะฟะพัะปะต ัะพะณะปะฐัะพะฒะฐะฝะธั ะะธัะตะบัะพัะฐ, ะพะถะธะดะฐััะธะต ะฟะพะปะฝะพะณะพ ะฟะพัััะฟะปะตะฝะธั |
| **ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ** | `item_status = COMPLETED` ะะะ `actual_quantity >= quantity` | ะะพะทะธัะธะธ ะฟะพะปะฝะพัััั ะทะฐะฒะตััะตะฝะฝัะต |

### 2. Workflow ะฟะพัะปะต ัะพะณะปะฐัะพะฒะฐะฝะธั ะะธัะตะบัะพัะฐ

```
ะะธัะตะบัะพั ัะพะณะปะฐัะพะฒัะฒะฐะตั
         โ
BACK_TO_SUPPLY_AFTER_DIRECTOR (ะกะฝะฐะฑะถะตะฝะตั ะฟะพะปััะฐะตั ะบะพะฝััะพะปั)
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะกะฝะฐะฑะถะตะฝะตั ะฒัะฑะธัะฐะตั ะฟััั:              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  1. PAYMENT (ะทะฐะบัะฟะบะฐ)                  โ
โ     โ                                  โ
โ  2. PAID (ะพะฟะปะฐัะตะฝะพ)                    โ
โ     โ                                  โ
โ  3. DELIVERY (ะดะพััะฐะฒะบะฐ)                โ
โ     โ                                  โ
โ  4. ะะขะ ะฝะฐะถะธะผะฐะตั "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต"  โ
โ     โ                                  โ
โ  5. COMPLETED (ะตัะปะธ actual >= quantity)โ
โ                                        โ
โ  ะะะ                                   โ
โ                                        โ
โ  1. SENT_TO_SITE (ัะพ ัะบะปะฐะดะฐ)           โ
โ     โ                                  โ
โ  2. WAREHOUSE_SHIPPING (ะพัะฟัะฐะฒะปะตะฝะพ)    โ
โ     โ                                  โ
โ  3. ะะขะ ะฝะฐะถะธะผะฐะตั "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต"  โ
โ     โ                                  โ
โ  4. COMPLETED (ะตัะปะธ actual >= quantity)โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 3. ะะฝะพะฟะบะฐ "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต"

**ะะพัััะฟ ัะพะปัะบะพ ะดะปั:**
- `SITE_MANAGER` (ะะฐัะฐะปัะฝะธะบ ััะฐััะบะฐ)
- `FOREMAN` (ะัะพัะฐะฑ)
- `MASTER` (ะะฐััะตั)
- `SITE_WAREHOUSE_MANAGER` (ะะฐะฒัะบะปะฐะด ะพะฑัะตะบัะฐ)

**ะฃัะปะพะฒะธะต ะฟะตัะตัะพะดะฐ ะฒ COMPLETED:**
```python
if actual_quantity >= quantity:
    item_status = COMPLETED
    # ะะพะทะธัะธั ะฟะตัะตัะพะดะธั ะฒ "ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ"
else:
    item_status = BACK_TO_SUPPLY_AFTER_DIRECTOR
    # ะะพะทะธัะธั ะะกะขะะะขะกะฏ ะฒ "ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ"
    # ะกะฝะฐะฑะถะตะฝะตั ะดะพะปะถะตะฝ ะดะพะฒะตะทัะธ ะฝะตะดะพััะฐััะตะต ะบะพะปะธัะตััะฒะพ
```

### 4. ะะพะฒะฐั ัะฐะฑะปะธัะฐ "ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ"

**ะะพะปะพะฝะบะธ:**

| ะะพะปะพะฝะบะฐ | ะะฟะธัะฐะฝะธะต | ะััะพัะฝะธะบ ะดะฐะฝะฝัั |
|---------|----------|-----------------|
| ะะฐัะฐ | ะะฐัะฐ ัะพะทะดะฐะฝะธั ะทะฐัะฒะบะธ | `MaterialRequest.created_at` |
| ะะพะผะตั (ะฟ/ะฟ) | ะะพััะดะบะพะฒัะน ะฝะพะผะตั ะฒ ะทะฐัะฒะบะต | `MaterialRequestItem.order` |
| ะะฐัะตัะธะฐะป | ะะฐะทะฒะฐะฝะธะต ะผะฐัะตัะธะฐะปะฐ | `MaterialRequestItem.material_name` |
| ะะด. ะธะทะผ. | ะะดะธะฝะธัะฐ ะธะทะผะตัะตะฝะธั | `MaterialRequestItem.unit` |
| ะะพะป-ะฒะพ ะฟะพ ะทะฐัะฒะบะต | ะะฐะฟัะพัะตะฝะฝะพะต ะบะพะปะธัะตััะฒะพ | `MaterialRequestItem.quantity` |
| **ะะพะป-ะฒะพ ะฟะพ ัะฐะบัั** | ะคะฐะบัะธัะตัะบะธ ะฟะพะปััะตะฝะพ | `MaterialRequestItem.actual_quantity` |
| ะัะธะผะตัะฐะฝะธั | ะกะฟะตัะธัะธะบะฐัะธั | `MaterialRequestItem.specifications` |
| ะะฒัะพั | ะคะะ ะฐะฒัะพัะฐ ะทะฐัะฒะบะธ | `MaterialRequest.author.full_name` |
| ะกัะฐััั | ะขะตะบััะธะน ััะฐััั ะฟะพะทะธัะธะธ | `MaterialRequestItem.item_status_display` |
| ะะพัะปะตะดะฝะตะต ะดะตะนััะฒะธะต | ะะฐัะฐ ะพะฑะฝะพะฒะปะตะฝะธั | `MaterialRequestItem.updated_at` |
| ะะตะนััะฒะธั | ะะฝะพะฟะบะธ ัะฟัะฐะฒะปะตะฝะธั | ะะฐะฒะธัะธั ะพั ัะพะปะธ ะธ ััะฐัััะฐ |

**ะัะพะฑะตะฝะฝะพััั:** ะะพะปะพะฝะบะฐ "ะะพะป-ะฒะพ ะฟะพ ัะฐะบัั" ะดะพะปะถะฝะฐ ะฑััั **ัะตะดะฐะบัะธััะตะผะพะน** ะดะปั ะฐะฒัะพัะฐ ะทะฐัะฒะบะธ (ั ะฟัะฐะฒะฐะผะธ edit).

---

## ๐ ะะฝะฐะปะธะท ัะตะบััะตะน ัะตะฐะปะธะทะฐัะธะธ

### โ ะงัะพ ัะถะต ะตััั:

1. **ะะพะปะต `actual_quantity`** โ ะตััั ะฒ ะผะพะดะตะปะธ `MaterialRequestItem` (ัััะพะบะฐ 525-532)
2. **ะะตะดะฐะบัะธััะตะผะพะต ะฟะพะปะต ะฝะฐ ััะพะฝัะต** โ ัะถะต ัะตะฐะปะธะทะพะฒะฐะฝะพ ะฒ ัะฐะฑะปะธัะต MaterialRequests.tsx (ัััะพะบะธ 827-886)
3. **Endpoint `recordActualQuantity`** โ ัะพะทะดะฐะตั ะทะฐะฟะธัั ะฝะฐ ัะบะปะฐะดะต ะธ ะพะฑะฝะพะฒะปัะตั actual_quantity ะฐัะพะผะฐัะฝะพ
4. **ะััะผัะต ะฟะตัะตัะพะดั ะดะปั SUPPLY_MANAGER** โ ัะพะปัะบะพ ััะพ ะดะพะฑะฐะฒะธะปะธ (BUG_SUPPLY_MANAGER_PAYMENT.md)
5. **ProcessStatus ัะพ ะฒัะตะผะธ ััะฐัััะฐะผะธ** โ ะฒัะต 19 ััะฐัััะพะฒ ัะถะต ะตััั ะฒ ะผะพะดะตะปะธ

### โ ะงะตะณะพ ะะะข:

1. **ะคะธะปัััะฐัะธะธ ะฟะพ ัะฐะทะดะตะปะฐะผ** โ ะฝะตั ะฒะบะปะฐะดะพะบ "ะะฐ ัะพะณะปะฐัะพะฒะฐะฝะธะธ" / "ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต" / "ะััะฐะฑะพัะฐะฝะฝัะต"
2. **ะะพะณะธะบะธ ะฟัะพะฒะตัะบะธ actual_quantity ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ** โ ะฟะพะทะธัะธั ะผะพะถะตั ััะฐัั COMPLETED ะดะฐะถะต ะตัะปะธ ัะฐะบั < ะทะฐัะฒะบะธ
3. **ะะณัะฐะฝะธัะตะฝะธั ะดะพัััะฟะฐ ะบ ะบะฝะพะฟะบะต "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต"** โ ัะตะนัะฐั ะดะพัััะฟะฝะฐ ัะตัะตะท `canMarkAsCompleted()` ะดะปั ะฒัะตั ะะขะ
4. **ะัะดะตะปัะฝะพะน ัะฐะฑะปะธัั ะดะปั ัะพะณะปะฐัะพะฒะฐะฝะฝัั** โ ะฝะตั ะพัะดะตะปัะฝะพะณะพ ัะฐะทะดะตะปะฐ ั ะฝัะถะฝัะผะธ ะบะพะปะพะฝะบะฐะผะธ

---

## ๐๏ธ ะะตะบะพะผะตะฝะดัะตะผะพะต ัะตัะตะฝะธะต

### ะะฐัะธะฐะฝั 1: ะะธะฝะธะผะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั (ะััััะพ, 2-3 ัะฐัะฐ) โญ ะะะะะะะะะฃะฎ

**ะงัะพ ัะดะตะปะฐัั:**

1. **ะะพะฑะฐะฒะธัั ะฒะบะปะฐะดะบะธ-ัะธะปัััั ะฝะฐ ัััะฐะฝะธัะต MaterialRequests.tsx:**
   ```tsx
   <Tabs defaultActiveKey="all">
     <TabPane tab="ะัะต ะทะฐัะฒะบะธ" key="all">...</TabPane>
     <TabPane tab="ะะฐ ัะพะณะปะฐัะพะฒะฐะฝะธะธ" key="in_progress">...</TabPane>
     <TabPane tab="ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ" key="approved">...</TabPane>
     <TabPane tab="ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ" key="completed">...</TabPane>
   </Tabs>
   ```

2. **ะะพะฑะฐะฒะธัั ะปะพะณะธะบั ัะธะปัััะฐัะธะธ:**
   ```tsx
   const IN_PROGRESS_STATUSES = [
     'UNDER_REVIEW', 'WAREHOUSE_CHECK', 'BACK_TO_SUPPLY',
     'ENGINEER_APPROVAL', 'BACK_TO_SUPPLY_AFTER_ENGINEER',
     'PROJECT_MANAGER_APPROVAL', 'BACK_TO_SUPPLY_AFTER_PM',
     'DIRECTOR_APPROVAL', 'RETURNED_FOR_REVISION'
   ];

   const APPROVED_STATUSES = [
     'BACK_TO_SUPPLY_AFTER_DIRECTOR', 'APPROVED',
     'PAYMENT', 'PAID', 'DELIVERY'
   ];

   const filteredData = flatData.filter(row => {
     if (activeTab === 'in_progress') {
       return IN_PROGRESS_STATUSES.includes(row.material?.item_status);
     }
     if (activeTab === 'approved') {
       const status = row.material?.item_status;
       const actual = row.material?.actual_quantity || 0;
       const requested = row.material?.quantity || 0;
       return APPROVED_STATUSES.includes(status) && actual < requested;
     }
     if (activeTab === 'completed') {
       const status = row.material?.item_status;
       const actual = row.material?.actual_quantity || 0;
       const requested = row.material?.quantity || 0;
       return status === 'COMPLETED' || actual >= requested;
     }
     return true; // ะัะต ะทะฐัะฒะบะธ
   });
   ```

3. **ะะณัะฐะฝะธัะธัั ะดะพัััะฟ ะบ ะบะฝะพะฟะบะต "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต":**
   ```tsx
   // ะ MaterialRequests.tsx
   const canAcceptOnSite = () => {
     const allowedRoles = ['SITE_MANAGER', 'FOREMAN', 'MASTER', 'SITE_WAREHOUSE_MANAGER'];
     return allowedRoles.includes(user?.role || '');
   };

   // ะ ัะตะฝะดะตัะต ะบะฝะพะฟะบะธ DELIVERY โ COMPLETED (ัััะพะบะฐ 1172)
   {itemStatus === 'DELIVERY' && canAcceptOnSite() && !isCancelled && record.material && (
     <Button
       type="primary"
       icon={<CheckOutlined />}
       size="small"
       onClick={() => handleChangeItemStatus(record.material, 'COMPLETED', ...)}
       block
     >
       ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต
     </Button>
   )}
   ```

4. **ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั actual_quantity ะฝะฐ backend ะฟัะธ ะฟะตัะตัะพะดะต ะฒ COMPLETED:**
   ```python
   # ะ backend/apps/material_requests/views.py ะฒ ะผะตัะพะดะต change_item_status (ะฟะพัะปะต ัััะพะบะธ 938)

   # ะัะปะธ ะฟะตัะตัะพะดะธะผ ะฒ COMPLETED, ะฟัะพะฒะตััะตะผ actual_quantity
   if new_status == 'COMPLETED':
       actual = item.actual_quantity or 0
       requested = item.quantity

       if actual < requested:
           # ะะต ัะฐะทัะตัะฐะตะผ ะทะฐะฒะตััะตะฝะธะต, ะฒะพะทะฒัะฐัะฐะตะผ ะพะฑัะฐัะฝะพ
           return Response({
               'detail': f'ะะตะฒะพะทะผะพะถะฝะพ ะทะฐะฒะตััะธัั ะฟะพะทะธัะธั: ะฟะพ ัะฐะบัั ะฟะพะปััะตะฝะพ {actual} {item.unit}, ะฐ ะทะฐะฟัะพัะตะฝะพ {requested} {item.unit}. ะะตะพะฑัะพะดะธะผะพ ะฟะพะปััะธัั ะตัะต {requested - actual} {item.unit}.',
               'actual_quantity': actual,
               'requested_quantity': requested,
               'missing_quantity': requested - actual
           }, status=status.HTTP_400_BAD_REQUEST)
   ```

**ะะปััั:**
- โ ะะธะฝะธะผะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั ะบะพะดะฐ
- โ ะัะฟะพะปัะทัะตะผ ัััะตััะฒััััั ะธะฝััะฐััััะบัััั
- โ ะะต ััะตะฑัะตั ะผะธะณัะฐัะธะน ะะ
- โ ะััััะฐั ัะตะฐะปะธะทะฐัะธั (2-3 ัะฐัะฐ)
- โ ะัะต ััะตะฑะพะฒะฐะฝะธั ะฒัะฟะพะปะฝะตะฝั

**ะะธะฝััั:**
- โ๏ธ ะะตั ะพัะดะตะปัะฝะพะณะพ endpoint ะดะปั ัะพะณะปะฐัะพะฒะฐะฝะฝัั ะทะฐัะฒะพะบ
- โ๏ธ ะคะธะปัััะฐัะธั ะฟัะพะธััะพะดะธั ะฝะฐ ััะพะฝัะต (ะฝะต ะบัะธัะธัะฝะพ, ะดะฐะฝะฝัะต ะธ ัะฐะบ ะทะฐะณััะถะฐัััั ะฟะพ ะฟัะพะตะบัั)

---

### ะะฐัะธะฐะฝั 2: ะะพะปะฝะพัะตะฝะฝะฐั ัะตะฐะปะธะทะฐัะธั (ะกะปะพะถะฝะพ, 1-2 ะดะฝั)

**ะงัะพ ัะดะตะปะฐัั:**

1. **ะกะพะทะดะฐัั ะฝะพะฒัะน endpoint ะฝะฐ backend:**
   ```python
   # ะ backend/apps/material_requests/views.py

   @action(detail=False, methods=['get'], url_path='approved-items')
   def get_approved_items(self, request):
       """ะะพะปััะธัั ะฒัะต ัะพะณะปะฐัะพะฒะฐะฝะฝัะต ะฟะพะทะธัะธะธ (ะพะถะธะดะฐััะธะต ะฟะพะปะฝะพะณะพ ะฟะพัััะฟะปะตะฝะธั)"""
       project_id = request.query_params.get('project')

       items = MaterialRequestItem.objects.filter(
           request__project_id=project_id,
           item_status__in=[
               'BACK_TO_SUPPLY_AFTER_DIRECTOR', 'APPROVED',
               'PAYMENT', 'PAID', 'DELIVERY'
           ],
           status='ACTIVE'
       ).annotate(
           missing_quantity=F('quantity') - Coalesce(F('actual_quantity'), 0)
       ).filter(
           missing_quantity__gt=0  # ะขะพะปัะบะพ ัะต, ะณะดะต ะตััั ะฝะตะดะพััะฐัะฐ
       ).select_related('request', 'request__author')

       serializer = self.get_serializer(items, many=True)
       return Response(serializer.data)
   ```

2. **ะกะพะทะดะฐัั ะพัะดะตะปัะฝัั ัััะฐะฝะธัั `/dashboard/material-requests/approved`**

3. **ะะพะฑะฐะฒะธัั ะฒััะธัะปัะตะผะพะต ะฟะพะปะต `missing_quantity` ะฒ serializer:**
   ```python
   class MaterialRequestItemSerializer(serializers.ModelSerializer):
       missing_quantity = serializers.SerializerMethodField()

       def get_missing_quantity(self, obj):
           actual = obj.actual_quantity or 0
           return max(0, obj.quantity - actual)
   ```

4. **ะกะพะทะดะฐัั ะพัะดะตะปัะฝัะน ะบะพะผะฟะพะฝะตะฝั `ApprovedMaterialRequests.tsx`** ั ะฝัะถะฝัะผะธ ะบะพะปะพะฝะบะฐะผะธ

**ะะปััั:**
- โ ะงะธััะฐั ะฐััะธัะตะบัััะฐ
- โ ะคะธะปัััะฐัะธั ะฝะฐ ััะพะฒะฝะต ะะ (ะฑััััะตะต)
- โ ะััะธัะปัะตะผัะต ะฟะพะปั (missing_quantity)
- โ ะัะดะตะปัะฝัะน ะผะฐััััั ะฒ ะผะตะฝั

**ะะธะฝััั:**
- โ ะขัะตะฑัะตั ะฑะพะปััะต ะฒัะตะผะตะฝะธ (1-2 ะดะฝั)
- โ ะัะฑะปะธัะพะฒะฐะฝะธะต ะบะพะดะฐ (ะฝะพะฒะฐั ัััะฐะฝะธัะฐ, serializer)
- โ ะฃัะปะพะถะฝะตะฝะธะต ััััะบัััั ะฟัะพะตะบัะฐ

---

## ๐ ะัะพะณะพะฒะฐั ัะตะบะพะผะตะฝะดะฐัะธั

**ะัะฟะพะปัะทะพะฒะฐัั ะะฐัะธะฐะฝั 1** โ ะผะธะฝะธะผะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั ั ะฒะบะปะฐะดะบะฐะผะธ-ัะธะปัััะฐะผะธ.

### ะะพัะตะผั:

1. **ะััััะฐั ัะตะฐะปะธะทะฐัะธั** โ 2-3 ัะฐัะฐ ะฒะผะตััะพ 1-2 ะดะฝะตะน
2. **ะัะต ััะตะฑะพะฒะฐะฝะธั ะฒัะฟะพะปะฝะตะฝั** โ ัะธะปัััะฐัะธั, ะบะพะฝััะพะปั ัะฐะบัะฐ, ะพะณัะฐะฝะธัะตะฝะธะต ะดะพัััะฟะฐ
3. **ะะต ััะปะพะถะฝัะตั ะฐััะธัะตะบัััั** โ ะพััะฐะตััั ะพะดะฝะฐ ัััะฐะฝะธัะฐ ั ะฒะบะปะฐะดะบะฐะผะธ
4. **ะะตะณะบะพ ัะตััะธัะพะฒะฐัั** โ ะธะทะผะตะฝะตะฝะธั ะปะพะบะฐะปะธะทะพะฒะฐะฝั
5. **ะะพะถะฝะพ ัะดะตะปะฐัั ะธัะตัะฐัะธะฒะฝะพ** โ ัะฝะฐัะฐะปะฐ ะฒะบะปะฐะดะบะธ, ะฟะพัะพะผ ะปะพะณะธะบั ะฟัะพะฒะตัะบะธ

---

## ๐ ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ (ะะฐัะธะฐะฝั 1)

### ะจะฐะณ 1: ะะพะฑะฐะฒะธัั ะฒะบะปะฐะดะบะธ-ัะธะปัััั ะฝะฐ ััะพะฝัะต (30 ะผะธะฝ)
- ะคะฐะนะป: `/frontend/src/pages/MaterialRequests.tsx`
- ะะพะฑะฐะฒะธัั `<Tabs>` ั 4 ะฒะบะปะฐะดะบะฐะผะธ
- ะะตะฐะปะธะทะพะฒะฐัั ััะฝะบัะธั ัะธะปัััะฐัะธะธ `getFilteredData()`

### ะจะฐะณ 2: ะะณัะฐะฝะธัะธัั ะดะพัััะฟ ะบ ะบะฝะพะฟะบะต "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต" (15 ะผะธะฝ)
- ะคะฐะนะป: `/frontend/src/pages/MaterialRequests.tsx`
- ะกะพะทะดะฐัั ััะฝะบัะธั `canAcceptOnSite()`
- ะัะธะผะตะฝะธัั ะบ ะบะฝะพะฟะบะฐะผ ะฒ ััะฐัััะฐั DELIVERY ะธ WAREHOUSE_SHIPPING

### ะจะฐะณ 3: ะะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั actual_quantity ะฝะฐ backend (30 ะผะธะฝ)
- ะคะฐะนะป: `/backend/apps/material_requests/views.py`
- ะ ะผะตัะพะดะต `change_item_status` ะดะพะฑะฐะฒะธัั ะฟัะพะฒะตัะบั ะฟะตัะตะด ะฟะตัะตัะพะดะพะผ ะฒ COMPLETED
- ะะตัะฝััั ะฟะพะฝััะฝัั ะพัะธะฑะบั ั ัะบะฐะทะฐะฝะธะตะผ ะฝะตะดะพััะฐััะตะณะพ ะบะพะปะธัะตััะฒะฐ

### ะจะฐะณ 4: ะะพะฑะฐะฒะธัั ะฐะฒัะพะฒะพะทะฒัะฐั ะฒ BACK_TO_SUPPLY_AFTER_DIRECTOR (ะพะฟัะธะพะฝะฐะปัะฝะพ, 15 ะผะธะฝ)
- ะัะปะธ actual < quantity ะฟัะธ ะฟะพะฟััะบะต ะทะฐะฒะตััะตะฝะธั
- ะะฒัะพะผะฐัะธัะตัะบะธ ะฒะตัะฝััั ััะฐััั ะฒ BACK_TO_SUPPLY_AFTER_DIRECTOR
- ะกะฝะฐะฑะถะตะฝะตั ัะผะพะถะตั ะฟัะพะดะพะปะถะธัั ะดะพะฒะพะทะธัั ะผะฐัะตัะธะฐะป

### ะจะฐะณ 5: ะขะตััะธัะพะฒะฐะฝะธะต (30 ะผะธะฝ)
- ะกะพะทะดะฐัั ะทะฐัะฒะบั
- ะัะพะนัะธ ัะตะฟะพัะบั ัะพะณะปะฐัะพะฒะฐะฝะธั
- ะัะฟัะฐะฒะธัั ะฝะฐ ะพะฟะปะฐัั
- ะัะผะตัะธัั ะดะพััะฐะฒะปะตะฝะพ
- ะะพะฟัะพะฑะพะฒะฐัั ะฟัะธะฝััั ั actual < quantity (ะดะพะปะถะฝะฐ ะฑััั ะพัะธะฑะบะฐ)
- ะะฐะฟะพะปะฝะธัั actual = quantity
- ะัะธะฝััั ะฝะฐ ะพะฑัะตะบัะต (ะดะพะปะถะฝะพ ะฟะตัะตะนัะธ ะฒ COMPLETED)

**ะัะพะณะพ:** ~2 ัะฐัะฐ 30 ะผะธะฝัั

---

## ๐ ะะทะผะตะฝะตะฝะธั ะฒ ะบะพะดะต

### Frontend: `/frontend/src/pages/MaterialRequests.tsx`

#### 1. ะะพะฑะฐะฒะธัั ะธะผะฟะพัั Tabs:
```tsx
import { Tabs } from 'antd';
const { TabPane } = Tabs;
```

#### 2. ะะพะฑะฐะฒะธัั state ะดะปั ะฐะบัะธะฒะฝะพะน ะฒะบะปะฐะดะบะธ:
```tsx
const [activeTab, setActiveTab] = useState('all');
```

#### 3. ะะพะฑะฐะฒะธัั ะบะพะฝััะฐะฝัั ััะฐัััะพะฒ:
```tsx
const IN_PROGRESS_STATUSES = [
  'UNDER_REVIEW', 'WAREHOUSE_CHECK', 'BACK_TO_SUPPLY',
  'ENGINEER_APPROVAL', 'BACK_TO_SUPPLY_AFTER_ENGINEER',
  'PROJECT_MANAGER_APPROVAL', 'BACK_TO_SUPPLY_AFTER_PM',
  'DIRECTOR_APPROVAL', 'RETURNED_FOR_REVISION'
];

const APPROVED_STATUSES = [
  'BACK_TO_SUPPLY_AFTER_DIRECTOR', 'APPROVED',
  'PAYMENT', 'PAID', 'DELIVERY'
];
```

#### 4. ะะพะฑะฐะฒะธัั ััะฝะบัะธั ัะธะปัััะฐัะธะธ:
```tsx
const getFilteredData = (data: FlatMaterialRow[]) => {
  return data.filter(row => {
    const status = row.material?.item_status;
    const actual = row.material?.actual_quantity || 0;
    const requested = row.material?.quantity || 0;

    if (activeTab === 'in_progress') {
      return IN_PROGRESS_STATUSES.includes(status);
    }
    if (activeTab === 'approved') {
      return APPROVED_STATUSES.includes(status) && actual < requested;
    }
    if (activeTab === 'completed') {
      return status === 'COMPLETED' || actual >= requested;
    }
    return true; // all
  });
};
```

#### 5. ะะพะฑะฐะฒะธัั ััะฝะบัะธั ะฟัะพะฒะตัะบะธ ะดะพัััะฟะฐ:
```tsx
const canAcceptOnSite = () => {
  const allowedRoles = ['SITE_MANAGER', 'FOREMAN', 'MASTER', 'SITE_WAREHOUSE_MANAGER'];
  return allowedRoles.includes(user?.role || '');
};
```

#### 6. ะะฑะตัะฝััั ัะฐะฑะปะธัั ะฒ Tabs:
```tsx
<Tabs
  activeKey={activeTab}
  onChange={setActiveTab}
  style={{ marginTop: 16 }}
>
  <TabPane tab="ะัะต ะทะฐัะฒะบะธ" key="all">
    <Table
      columns={columns}
      dataSource={getFilteredData(flatData)}
      ...
    />
  </TabPane>
  <TabPane tab="ะะฐ ัะพะณะปะฐัะพะฒะฐะฝะธะธ" key="in_progress">
    <Table
      columns={columns}
      dataSource={getFilteredData(flatData)}
      ...
    />
  </TabPane>
  <TabPane tab={
    <span>
      ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ
      <Tag color="green" style={{ marginLeft: 8 }}>
        {getFilteredData(flatData).filter(r => APPROVED_STATUSES.includes(r.material?.item_status)).length}
      </Tag>
    </span>
  } key="approved">
    <Table
      columns={columns}
      dataSource={getFilteredData(flatData)}
      ...
    />
  </TabPane>
  <TabPane tab="ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ" key="completed">
    <Table
      columns={columns}
      dataSource={getFilteredData(flatData)}
      ...
    />
  </TabPane>
</Tabs>
```

#### 7. ะะทะผะตะฝะธัั ะบะฝะพะฟะบะธ DELIVERY ะธ WAREHOUSE_SHIPPING:
```tsx
// ะกััะพะบะฐ 1172 (DELIVERY โ COMPLETED)
{itemStatus === 'DELIVERY' && canAcceptOnSite() && !isCancelled && record.material && (
  <Button
    type="primary"
    icon={<CheckOutlined />}
    size="small"
    onClick={() => handleChangeItemStatus(record.material, 'COMPLETED', 'ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต', 'ะัะธะตะผ ะฝะฐ ะพะฑัะตะบัะต...', 'ะะพะทะธัะธั ะฟัะธะฝััะฐ ะฝะฐ ะพะฑัะตะบัะต')}
    block
  >
    ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต
  </Button>
)}

// ะกััะพะบะฐ 1198 (WAREHOUSE_SHIPPING โ COMPLETED)
{itemStatus === 'WAREHOUSE_SHIPPING' && canAcceptOnSite() && !isCancelled && record.material && (
  <Button
    type="primary"
    icon={<CheckOutlined />}
    size="small"
    onClick={() => handleChangeItemStatus(record.material, 'COMPLETED', 'ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต', 'ะัะธะตะผ ะฝะฐ ะพะฑัะตะบัะต...', 'ะะพะทะธัะธั ะฟัะธะฝััะฐ ะฝะฐ ะพะฑัะตะบัะต')}
    block
  >
    ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต
  </Button>
)}
```

---

### Backend: `/backend/apps/material_requests/views.py`

#### ะ ะผะตัะพะดะต `change_item_status` ะฟะพัะปะต ัััะพะบะธ 938 ะดะพะฑะฐะฒะธัั:

```python
# ะัะพะฒะตัะบะฐ: ะตัะปะธ ะฟะตัะตัะพะดะธะผ ะฒ COMPLETED, ะฟัะพะฒะตััะตะผ ัะฐะบัะธัะตัะบะพะต ะบะพะปะธัะตััะฒะพ
if new_status == 'COMPLETED':
    actual = item.actual_quantity or 0
    requested = item.quantity

    if actual < requested:
        missing = requested - actual
        return Response({
            'detail': (
                f'ะะตะฒะพะทะผะพะถะฝะพ ะทะฐะฒะตััะธัั ะฟะพะทะธัะธั: ะฟะพ ัะฐะบัั ะฟะพะปััะตะฝะพ {actual} {item.unit}, '
                f'ะฐ ะทะฐะฟัะพัะตะฝะพ {requested} {item.unit}. '
                f'ะะตะพะฑัะพะดะธะผะพ ะฟะพะปััะธัั ะตัะต {missing} {item.unit}.'
            ),
            'actual_quantity': float(actual),
            'requested_quantity': float(requested),
            'missing_quantity': float(missing)
        }, status=status.HTTP_400_BAD_REQUEST)
```

---

## โ ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั

ะะพัะปะต ัะตะฐะปะธะทะฐัะธะธ **ะะฐัะธะฐะฝัะฐ 1**:

1. โ ะะฐ ัััะฐะฝะธัะต `/dashboard/material-requests` ะฟะพัะฒัััั 4 ะฒะบะปะฐะดะบะธ
2. โ ะะบะปะฐะดะบะฐ "ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ" ะฟะพะบะฐะถะตั ัะพะปัะบะพ ะฟะพะทะธัะธะธ:
   - ะะพัะปะต ัะพะณะปะฐัะพะฒะฐะฝะธั ะะธัะตะบัะพัะฐ
   - ะก `actual_quantity < quantity`
3. โ ะะบะปะฐะดะบะฐ "ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ" ะฟะพะบะฐะถะตั:
   - ะะพะทะธัะธะธ ัะพ ััะฐัััะพะผ `COMPLETED`
   - ะะะ ะฟะพะทะธัะธะธ ั `actual_quantity >= quantity`
4. โ ะะฝะพะฟะบะฐ "ะัะธะฝััะพ ะฝะฐ ะพะฑัะตะบัะต" ะดะพัััะฟะฝะฐ ัะพะปัะบะพ ะดะปั:
   - ะะฐัะฐะปัะฝะธะบ ััะฐััะบะฐ
   - ะัะพัะฐะฑ
   - ะะฐััะตั
   - ะะฐะฒัะบะปะฐะด ะพะฑัะตะบัะฐ
5. โ ะัะธ ะฟะพะฟััะบะต ะทะฐะฒะตััะธัั ะฟะพะทะธัะธั ั ะฝะตะดะพััะฐัะตะน:
   - Backend ะฒะตัะฝะตั ะพัะธะฑะบั ั ัะบะฐะทะฐะฝะธะตะผ ะฝะตะดะพััะฐััะตะณะพ ะบะพะปะธัะตััะฒะฐ
   - ะะพะทะธัะธั ะพััะฐะฝะตััั ะฒ ััะฐัััะต DELIVERY
   - ะกะฝะฐะฑะถะตะฝะตั ะดะพะปะถะตะฝ ะฑัะดะตั ะดะพะฒะตะทัะธ ะผะฐัะตัะธะฐะป
6. โ ะขะพะปัะบะพ ะฟะพัะปะต ัะพะณะพ, ะบะฐะบ `actual_quantity >= quantity`:
   - ะะพะทะธัะธั ะผะพะถะตั ะฑััั ะทะฐะฒะตััะตะฝะฐ
   - ะะตัะตัะพะดะธั ะฒ "ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ"

---

## ๐จ ะะฐะบะตั ะฒะบะปะฐะดะพะบ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะัะพะตะบั: [ะะธะปะพะน ะบะพะผะฟะปะตะบั "ะะพััะพะด" โผ]                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  [ะัะต ะทะฐัะฒะบะธ] [ะะฐ ัะพะณะปะฐัะพะฒะฐะฝะธะธ] [ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ะทะฐัะฒะบะธ (5)]    โ
โ  [ะััะฐะฑะพัะฐะฝะฝัะต ะทะฐัะฒะบะธ]                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ะะฐัะฐ  โ โ โ ะะฐัะตัะธะฐะป  โ ะะด.โ ะะพ ะทะฐัะฒะบะต โ ะะพ ัะฐะบัั โ ะกัะฐััั  โ
โโโโโโโโโโผโโโโผโโโโโโโโโโโโผโโโโโผโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโค
โ 09.11  โ 1 โ ะัะผะฐัััะฐ  โ ั  โ   10.5    โ   8.0    โ ะะพััะฐะฒะบะฐโ
โ 09.11  โ 2 โ ะฆะตะผะตะฝั    โ ะผยณ โ    5.0    โ   3.5    โ ะะฐ ะพะฟะปะฐัะตโ
โ 08.11  โ 1 โ ะะธัะฟะธั    โ ัั โ  5000     โ   0      โ ะะฟะปะฐัะตะฝะพโ
โโโโโโโโโโดโโโโดโโโโโโโโโโโโดโโโโโดโโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโ
```

---

## ๐ ะะพะฟัะพัั ะดะปั ััะพัะฝะตะฝะธั

1. **ะะฒัะพะฒะพะทะฒัะฐั ะฝะฐ ะดะพัะฐะฑะพัะบั?**
   ะัะปะธ actual < quantity ะฟัะธ ะฟะพะฟััะบะต ะทะฐะฒะตััะตะฝะธั, ะฒะตัะฝััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒ BACK_TO_SUPPLY_AFTER_DIRECTOR ะธะปะธ ะฟัะพััะพ ะฟะพะบะฐะทะฐัั ะพัะธะฑะบั?

2. **ะฃะฒะตะดะพะผะปะตะฝะธั?**
   ะัะถะฝะพ ะปะธ ะพัะฟัะฐะฒะปััั email-ัะฒะตะดะพะผะปะตะฝะธะต ะกะฝะฐะฑะถะตะฝัั, ะบะพะณะดะฐ ะฟะพะทะธัะธั ะฒะพะทะฒัะฐัะฐะตััั ะธะท-ะทะฐ ะฝะตะดะพััะฐัะธ?

3. **ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน?**
   ะะพะณะธัะพะฒะฐัั ะปะธ ะฟะพะฟััะบะธ ะทะฐะฒะตััะตะฝะธั ั ะฝะตะดะพััะฐัะตะน ะฒ MaterialRequestHistory?

4. **ะงะฐััะธัะฝัะต ะฟะพััะฐะฒะบะธ?**
   ะัะปะธ ะผะฐัะตัะธะฐะป ะฟัะธัะพะดะธั ะฟะฐััะธัะผะธ (ะฝะฐะฟัะธะผะตั, 3ั, ะฟะพัะพะผ ะตัะต 5ั), ะบะฐะบ ััะพ ะพัะพะฑัะฐะถะฐัั? ะกะตะนัะฐั `actual_quantity` ะฟัะพััะพ ะฟะตัะตะทะฐะฟะธััะฒะฐะตััั.

---

**ะะพะบัะผะตะฝั ัะพะทะดะฐะฝ:** 2025-11-09
**ะะฒัะพั:** Claude Code
**ะกะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั:**
- `/MATERIAL_REQUESTS_APPROVAL_FLOW.md` โ ะฟะพะปะฝะพะต ะพะฟะธัะฐะฝะธะต workflow
- `/BUG_SUPPLY_MANAGER_PAYMENT.md` โ ะธัะฟัะฐะฒะปะตะฝะฝัะน ะฑะฐะณ ั ะฟััะผัะผะธ ะฟะตัะตัะพะดะฐะผะธ
- `/ROLES_REFERENCE.md` โ ัะฟัะฐะฒะพัะฝะธะบ ัะพะปะตะน ัะธััะตะผั
