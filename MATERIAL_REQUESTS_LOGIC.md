# Логика системы заявок на строительные материалы

## Обзор

Система заявок на строительные материалы предназначена для автоматизации процесса запроса, согласования и получения материалов на строительных объектах.

## Жизненный цикл заявки

### 1. Создание заявки (DRAFT)

**Кто может создавать:**
- Мастер (MASTER)
- Прораб (FOREMAN)
- Начальник участка (SITE_MANAGER)

**Процесс:**
1. Автор создает заявку с указанием:
   - Название заявки
   - Описание (опционально)
   - Проект
   - Список позиций (материалов):
     - Название материала
     - Единица измерения
     - Количество по заявке
     - Примечания

2. Заявке присваивается уникальный номер в формате: `MR-YYYYMMDD-XXX`
   - Пример: `MR-20251112-001`

3. Заявка сохраняется в статусе **DRAFT** (Черновик)

### 2. Отправка на согласование (IN_APPROVAL)

**Логика определения первого согласующего:**

- Если автор **Мастер** или **Прораб** → первый согласующий: **Начальник участка**
- Если автор **Начальник участка** → первый согласующий: **Инженер ПТО**

**Цепочка согласования (полная):**
```
Мастер → Прораб → Начальник участка → Инженер ПТО → 
Руководитель проекта → Главный инженер → Директор
```

**Особенности:**
- Если роль отсутствует в компании, этап автоматически пропускается
- Каждый этап может вернуть заявку на доработку автору
- Статус заявки показывает, на каком этапе она находится

### 3. Согласование (IN_APPROVAL)

**Возможности каждого этапа:**

1. **Согласовать** - заявка переходит на следующий этап
   - Можно добавить комментарий

2. **Вернуть на доработку** - заявка возвращается автору
   - **Обязательно** указать причину возврата
   - Статус меняется на REJECTED

### 4. Согласована (APPROVED)

После согласования **Директором** заявка переходит в статус **APPROVED** (Согласована)

**Роль снабженца:**
- Видит согласованные заявки
- Ищет поставщиков
- Может объявить позиции в тендер (на странице `/dashboard/tenders`)
- Переводит заявку на следующий этап: "На оплате"

### 5. На оплате (IN_PAYMENT)

**Доступно только снабженцу:**
- Видит кнопку "Оплачено"
- После нажатия заявка переходит в статус "На доставке"

**Остальные роли:**
- Видят только статус "На оплате"

### 6. На доставке (IN_DELIVERY)

**Кто может принять материалы:**
- Мастер
- Прораб
- Начальник участка
- Завсклад объекта (SITE_WAREHOUSE_MANAGER)

**Возможности:**
1. Указать фактическое количество для каждой позиции (вручную)
2. Нажать кнопку "Принято" → заявка переходит в статус COMPLETED

### 7. Отработана (COMPLETED)

Финальный статус заявки.

**Информация:**
- Статус: "Отработано и доставлено на объект"
- Доступна вся история изменений
- Видны все позиции с количеством по заявке и по факту

## Вкладки на странице заявок

### 1. Все заявки
**Колонки:**
- Номер (п/п)
- Материал
- Ед. изм.
- Кол-во по заявке
- Кол-во по факту
- Примечания
- Автор
- Статус
- Действия

**Фильтрация:** все заявки компании

### 2. На согласовании
**Колонки:**
- Номер (п/п)
- Материал
- Ед. изм.
- Кол-во по заявке
- Примечания
- Автор
- Статус (текущая роль для согласования)
- Действия (Согласовать / На доработку)

**Особенности:**
- Каждому сотруднику видно, на каком этапе согласования находится заявка
- В статусе отображается роль, которая еще не согласовала
- Если текущая роль пользователя совпадает, доступны кнопки действий

### 3. Согласованные заявки
**Колонки:**
- Номер (п/п)
- Материал
- Ед. изм.
- Кол-во по заявке
- Примечания
- Автор
- Статус
- Действия (для снабженца: "На оплату")

**Доступно:**
- Снабженец может переводить позиции на оплату
- Может объявить позиции в тендер

### 4. На оплате
**Колонки:**
- Номер (п/п)
- Материал
- Ед. изм.
- Кол-во по заявке
- Примечания
- Автор
- Статус
- Действия (для снабженца: "Оплачено")

**Видимость:**
- Снабженец: видит кнопку "Оплачено" и статус "На оплате"
- Остальные: только статус "На оплате"

### 5. На доставке
**Колонки:**
- Номер (п/п)
- Материал
- Ед. изм.
- Кол-во по заявке
- Кол-во по факту (можно редактировать)
- Примечания
- Автор
- Статус
- Действия (для принимающих: "Принято")

**Возможности:**
- Мастер, Прораб, Начальник участка, Завсклад объекта могут:
  - Вносить фактическое количество вручную
  - Нажать "Принято" → заявка переходит в COMPLETED

### 6. Отработанные заявки
**Колонки:**
- Номер (п/п)
- Материал
- Ед. изм.
- Кол-во по заявке
- Кол-во по факту
- Примечания
- Автор
- Статус ("Отработано и доставлено на объект")
- Действия

## API Endpoints

### Основные endpoints

```
GET    /api/material-requests/           - Список заявок
POST   /api/material-requests/           - Создать заявку
GET    /api/material-requests/{id}/      - Детали заявки
PUT    /api/material-requests/{id}/      - Обновить заявку
DELETE /api/material-requests/{id}/      - Удалить заявку
```

### Действия с заявкой

```
POST /api/material-requests/{id}/submit/              - Отправить на согласование
POST /api/material-requests/{id}/approve/             - Согласовать
POST /api/material-requests/{id}/reject/              - Вернуть на доработку
POST /api/material-requests/{id}/mark-payment/        - Перевести на оплату (снабженец)
POST /api/material-requests/{id}/mark-paid/           - Отметить как оплаченную (снабженец)
POST /api/material-requests/{id}/mark-received/       - Принять материалы
POST /api/material-requests/{id}/update-actual-quantity/ - Обновить фактическое количество
```

### Фильтрация

```
GET /api/material-requests/?tab=all            - Все заявки
GET /api/material-requests/?tab=in_approval    - На согласовании
GET /api/material-requests/?tab=approved       - Согласованные
GET /api/material-requests/?tab=in_payment     - На оплате
GET /api/material-requests/?tab=in_delivery    - На доставке
GET /api/material-requests/?tab=completed      - Отработанные
GET /api/material-requests/?tab=my             - Мои заявки
GET /api/material-requests/?tab=draft          - Черновики
```

## Модели базы данных

### MaterialRequest
Основная модель заявки.

**Поля:**
- `request_number` - Уникальный номер (MR-YYYYMMDD-XXX)
- `title` - Название заявки
- `description` - Описание
- `author` - Автор заявки
- `project` - Проект
- `company` - Компания
- `status` - Статус (DRAFT, IN_APPROVAL, APPROVED, IN_PAYMENT, IN_DELIVERY, COMPLETED, REJECTED)
- `current_approval_role` - Текущая роль для согласования
- Даты: created_at, updated_at, submitted_at, approved_at, completed_at
- Поля для возврата: rejection_reason, rejected_by, rejected_at

### MaterialRequestItem
Позиция заявки (материал).

**Поля:**
- `material_request` - Заявка
- `position_number` - Номер позиции
- `material_name` - Название материала
- `unit` - Единица измерения
- `quantity_requested` - Количество по заявке
- `quantity_actual` - Количество по факту (заполняется при получении)
- `notes` - Примечания
- `tender` - Связь с тендером (если объявлена)

### ApprovalStep
Этап согласования заявки.

**Поля:**
- `material_request` - Заявка
- `role` - Роль согласующего
- `status` - Статус (PENDING, APPROVED, REJECTED)
- `approved_by` - Кто согласовал
- `approved_at` - Дата согласования
- `comment` - Комментарий

### MaterialRequestHistory
История изменений заявки.

**Поля:**
- `material_request` - Заявка
- `action` - Действие (CREATED, SUBMITTED, APPROVED, REJECTED, PAYMENT, PAID, COMPLETED)
- `user` - Пользователь, выполнивший действие
- `created_at` - Дата действия
- `details` - Дополнительные детали (JSON)
- `comment` - Комментарий

## Права доступа

Права доступа управляются через систему ButtonAccess (`/admin/core/buttonaccess/`).

### Страница material-requests
**Доступ:** Все роли с правами на страницу

### Кнопки/действия:

1. **create** - Создать заявку
   - Доступно: Мастер, Прораб, Начальник участка

2. **submit** - Отправить на согласование
   - Доступно: Автор заявки

3. **approve** - Согласовать
   - Доступно: Текущая роль в цепочке согласования

4. **reject** - Вернуть на доработку
   - Доступно: Любая роль в цепочке согласования

5. **mark_payment** - Перевести на оплату
   - Доступно: Снабженец

6. **mark_paid** - Отметить как оплаченную
   - Доступно: Снабженец

7. **mark_received** - Принять материалы
   - Доступно: Мастер, Прораб, Начальник участка, Завсклад объекта

8. **update_quantity** - Обновить фактическое количество
   - Доступно: Мастер, Прораб, Начальник участка, Завсклад объекта

## Уведомления

При каждом изменении статуса заявки отправляются уведомления:

- **Создание** → Автору
- **Отправка на согласование** → Текущему согласующему
- **Согласование** → Следующему согласующему / Снабженцу (если финальное)
- **Возврат на доработку** → Автору
- **На оплате** → Директору, Снабженцу
- **Оплачено** → Начальнику участка, Завсклад объекта
- **На доставке** → Мастеру, Прорабу, Начальнику участка
- **Получено** → Автору, Снабженцу

## Интеграция с тендерами

Снабженец может объявить позиции из согласованной заявки в тендер:

1. На странице `/dashboard/tenders` создает новый тендер
2. Связывает позиции заявки с тендером
3. После завершения тендера выбирает поставщика
4. Переводит заявку на оплату

## Примеры использования

### Создание заявки

```javascript
POST /api/material-requests/

{
  "title": "Материалы для фундамента",
  "description": "Срочная заявка",
  "project": 1,
  "items": [
    {
      "material_name": "Цемент М500",
      "unit": "тонн",
      "quantity_requested": 50,
      "notes": "Высокое качество"
    },
    {
      "material_name": "Песок речной",
      "unit": "м³",
      "quantity_requested": 100,
      "notes": ""
    }
  ]
}
```

### Отправка на согласование

```javascript
POST /api/material-requests/1/submit/

// Ответ:
{
  "message": "Заявка успешно отправлена на согласование",
  "current_approval_role": "SITE_MANAGER"
}
```

### Согласование

```javascript
POST /api/material-requests/1/approve/

{
  "comment": "Согласовано, материалы необходимы"
}

// Ответ:
{
  "message": "Заявка успешно согласована",
  "status": "IN_APPROVAL",
  "next_approval_role": "ENGINEER"
}
```

### Возврат на доработку

```javascript
POST /api/material-requests/1/reject/

{
  "reason": "Неправильно указано количество цемента"
}
```

### Обновление фактического количества

```javascript
POST /api/material-requests/1/update-actual-quantity/

{
  "item_id": 1,
  "quantity_actual": 48.5
}
```

## Следующие шаги

1. Создать frontend компоненты для страницы заявок
2. Настроить права доступа через ButtonAccess
3. Добавить систему уведомлений
4. Добавить экспорт заявок в Excel/PDF
5. Добавить аналитику по заявкам
