# –†–ï–ó–Æ–ú–ï: –ê–ù–ê–õ–ò–ó –°–ò–°–¢–ï–ú–´ –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Ø –ó–ê–Ø–í–û–ö

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 14.11.2025  
**–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:** –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ (Very Thorough)  
**–°—Ç–∞—Ç—É—Å:** –í—ã—è–≤–ª–µ–Ω–æ 10 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º  

---

## –¢–û–ü 5 –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú

### 1. üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ 0005
- **–§–∞–π–ª:** `migrations/0005_alter_materialrequest_request_number_and_more.py`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `material_requests_materialrequest` –≤–º–µ—Å—Ç–æ `material_requests`
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** Unique constraint –Ω–∞ request_number –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–±–∞–≤–∏—Ç—Å—è
- **–†–∏—Å–∫:** Duplicate request_number –≤ —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏—è—Ö
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ `material_requests`

### 2. üî¥ –ö–†–ò–¢–ò–ß–ù–û: Company field –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –∫–æ–¥–æ–º –∏ –ë–î
- **–§–∞–π–ª:** `views.py` (—Å—Ç—Ä–æ–∫–∏ 73, 558), `serializers.py` (—Å—Ç—Ä–æ–∫–∞ 132)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≥–æ–≤–æ—Ä–∏—Ç "–∫–æ–º–ø–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ project.company", –Ω–æ –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ `company` field
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** AttributeError –≤ production, –µ—Å–ª–∏ field –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –í–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `project__company` –≤–º–µ—Å—Ç–æ `company`

### 3. üî¥ –ö–†–ò–¢–ò–ß–ù–û: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ project –ø—Ä–∏ approve/reject
- **–§–∞–π–ª:** `views.py`, –º–µ—Ç–æ–¥—ã `approve()` –∏ `reject()`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–æ–ª—å, –Ω–æ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–∂–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É –¥—Ä—É–≥–æ–≥–æ
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `if material_request.project not in user_projects`

### 4. üî¥ –ö–†–ò–¢–ò–ß–ù–û: Race condition –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
- **–§–∞–π–ª:** `models.py`, –º–µ—Ç–æ–¥ `generate_request_number()` (233-236)
- **–ü—Ä–æ–±–ª–µ–º–∞:** `select_for_update()` –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç, –µ—Å–ª–∏ filter() –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω—É–ª
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –î–≤—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –∑–∞—è–≤–∫–∞–º –º–æ–∂–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `order_by('-request_number').first()` —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π

### 5. üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ù–µ—Ç fallback –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π first_role
- **–§–∞–π–ª:** `models.py`, –º–µ—Ç–æ–¥ `submit_for_approval()` (252-278)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç –Ω—É–∂–Ω–æ–π —Ä–æ–ª–∏, –∑–∞—è–≤–∫–∞ –∑–∞–≤–∏—Å–Ω–µ—Ç –Ω–∞ IN_APPROVAL
- **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É, –µ—Å–ª–∏ —Ä–æ–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å fallback - –ø–æ–∏—Å–∫ —Å–ª–µ–¥—É—é—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ä–æ–ª–∏ –≤ —Ü–µ–ø–æ—á–∫–µ

---

## –ú–ê–¢–†–ò–¶–ê –†–ò–°–ö–û–í

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ö–æ–ª-–≤–æ | –ü—Ä–∏–º–µ—Ä—ã |
|-----------|--------|---------|
| üî¥ –ö–†–ò–¢–ò–ß–ù–û | 6 | –ú–∏–≥—Ä–∞—Ü–∏–∏, company field, project check, race condition, first_role fallback, author!=NULL |
| üü† –°–†–ï–î–ù–ò–ô | 3 | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–µ–π, statistics –ºismatch, permission checks |
| üü° –ù–ò–ó–ö–ò–ô | 1 | ApprovalStep comment not saved |

---

## –§–ê–ô–õ–´ –ü–†–û–ï–ö–¢–ê

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è:

1. **Backend:**
   - `/backend/apps/material_requests/models.py` (825 —Å—Ç—Ä–æ–∫)
   - `/backend/apps/material_requests/views.py` (588 —Å—Ç—Ä–æ–∫)
   - `/backend/apps/material_requests/serializers.py` (491 —Å—Ç—Ä–æ–∫)
   - `/backend/apps/material_requests/admin.py` (541 —Å—Ç—Ä–æ–∫)
   - `/backend/apps/material_requests/urls.py` (17 —Å—Ç—Ä–æ–∫)
   - `/backend/apps/material_requests/migrations/` (7 —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π)

2. **Frontend:**
   - `/frontend/src/api/materialRequests.ts`
   - `/frontend/src/pages/MaterialRequests.tsx`

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - `/MATERIAL_REQUESTS_LOGIC.md`
   - `/MATERIAL_REQUESTS_UI_SPEC.md`

---

## –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –≠–¢–ê–ü 1: –ù–ï–ú–ï–î–õ–ï–ù–ù–û (Production Hotfix)
–í—Ä–µ–º—è: 2-3 —á–∞—Å–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 0005 (–∏–º—è —Ç–∞–±–ª–∏—Ü—ã)
2. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ company (views + serializers)
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É project –¥–æ—Å—Ç—É–ø–∞ –≤ approve/reject
4. –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è first_role

### –≠–¢–ê–ü 2: –í —Å–ª–µ–¥—É—é—â–µ–º —Å–ø—Ä–∏–Ω—Ç–µ
–í—Ä–µ–º—è: 1 –¥–µ–Ω—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

5. –°–æ–∫—Ä–∞—Ç–∏—Ç—å timeout –∫—ç—à–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π
6. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤ statistics()
7. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É author!=NULL
8. –£–ª—É—á—à–∏—Ç—å race condition protection

### –≠–¢–ê–ü 3: –ü–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
–í—Ä–µ–º—è: 1-2 –¥–Ω—è

9. –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è approval flow
10. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è race conditions
11. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## –î–ï–¢–ê–õ–¨–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´

–î–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–º–æ—Ç—Ä–∏—Ç–µ:

1. **APPROVAL_FLOW_ANALYSIS.md** (22 KB)
   - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Å–∫–∞
   - –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏

2. **APPROVAL_FLOW_FIXES.md** (17 KB)
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã
   - Before/After –ø—Ä–∏–º–µ—Ä—ã
   - –ü–æ–ª–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## QUICK REFERENCE: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –§–ê–ô–õ–´ –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

```
PRIORITY 1 (MUST FIX):
[ ] migrations/0005_alter_materialrequest_request_number_and_more.py (line 15)
[ ] views.py (lines 73, 558, 581, 217-223)
[ ] serializers.py (lines 132, 227, 296)
[ ] models.py (lines 280, 252, 233)

PRIORITY 2 (SHOULD FIX):
[ ] models.py (line 368)
[ ] views.py (lines 572-582)
[ ] admin.py (–≤—Å—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ company)

PRIORITY 3 (NICE TO HAVE):
[ ] views.py (lines 225-238)
[ ] –î–æ–±–∞–≤–∏—Ç—å tests
[ ] –î–æ–±–∞–≤–∏—Ç—å logging
```

---

## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï PRODUCTION

### –ß—Ç–æ –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:
- `views.py` line 558 - –µ—Å–ª–∏ –Ω–µ—Ç company field –≤ –ë–î
- `serializers.py` line 132 - –µ—Å–ª–∏ –Ω–µ—Ç company field –≤ –ë–î
- `get_first_approval_role()` - –µ—Å–ª–∏ author=NULL
- –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ approve/reject –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏

### –ß—Ç–æ –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ:
- Race condition –≤ –Ω–æ–º–µ—Ä–µ –∑–∞—è–≤–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞—è–≤–∫–µ
- –ö—ç—à —Ä–æ–ª–µ–π "—É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç" –∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è 5 –º–∏–Ω—É—Ç
- Statistics –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏

### –ß—Ç–æ –±—É–¥–µ—Ç —Ç–∏—Ö–æ –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å:
- Unique constraint –Ω–∞ request_number (—É–∂–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è

---

## –ú–ï–¢–†–ò–ö–ò

- **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º–µ:** ~2,445 —Å—Ç—Ä–æ–∫ (backend) + ~Frontend
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤:** 13 (backend) + 3 (frontend) + 2 (docs)
- **–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å issues –≤ production:** –í—ã—Å–æ–∫–∞—è (–∫–æ–º–ø–∞–Ω–∏—è field, —É—è–∑–≤–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–∞)
- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:** 100% (—Å–∏—Å—Ç–µ–º–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–∂–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å)

---

## –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

‚ö†Ô∏è **–ü–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –≤ production –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ company field –≤ –ë–î production
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª –ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω unique constraint –∏–∑ 0005
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É project –¥–æ—Å—Ç—É–ø–∞
4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è race conditions

---

**–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ APPROVAL_FLOW_FIXES.md**
