import { useState } from 'react'
import {
  Typography,
  Button,
  Table,
  Modal,
  Form,
  Input,
  Upload,
  message,
  Popconfirm,
  Space,
  Tag,
} from 'antd'
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  FilePdfOutlined,
  UploadOutlined,
  DownloadOutlined,
} from '@ant-design/icons'
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { technicalConditionsAPI, TechnicalCondition } from '../api/technicalConditions'
import { useAuthStore } from '../stores/authStore'
import type { UploadFile } from 'antd'
import dayjs from 'dayjs'

const { Title, Text } = Typography
const { TextArea } = Input

const TechnicalConditions = () => {
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [editingRecord, setEditingRecord] = useState<TechnicalCondition | null>(null)
  const [form] = Form.useForm()
  const [fileList, setFileList] = useState<UploadFile[]>([])
  const queryClient = useQueryClient()
  const currentUser = useAuthStore(state => state.user)

  // Проверка прав на добавление/редактирование/удаление
  const canManage = () => {
    if (!currentUser) return false
    if (currentUser.is_superuser) return true

    const allowedRoles = [
      'ENGINEER',           // Инженер ПТО
      'CHIEF_ENGINEER',     // Главный инженер
      'SITE_MANAGER',       // Начальник участка
      'FOREMAN',            // Прораб
      'PROJECT_MANAGER',    // Руководитель проекта
      'DIRECTOR'            // Директор
    ]

    return allowedRoles.includes(currentUser.role)
  }

  // Получение списка техусловий
  const { data: technicalConditions, isLoading } = useQuery({
    queryKey: ['technical-conditions'],
    queryFn: technicalConditionsAPI.getTechnicalConditions,
  })

  // Создание техусловия
  const createMutation = useMutation({
    mutationFn: technicalConditionsAPI.createTechnicalCondition,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['technical-conditions'] })
      message.success('Техусловие успешно добавлено')
      handleCloseModal()
    },
    onError: (error: any) => {
      message.error(error.response?.data?.detail || 'Ошибка при добавлении техусловия')
    },
  })

  // Обновление техусловия
  const updateMutation = useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) =>
      technicalConditionsAPI.updateTechnicalCondition(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['technical-conditions'] })
      message.success('Техусловие успешно обновлено')
      handleCloseModal()
    },
    onError: (error: any) => {
      message.error(error.response?.data?.detail || 'Ошибка при обновлении техусловия')
    },
  })

  // Удаление техусловия
  const deleteMutation = useMutation({
    mutationFn: technicalConditionsAPI.deleteTechnicalCondition,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['technical-conditions'] })
      message.success('Техусловие успешно удалено')
    },
    onError: (error: any) => {
      message.error(error.response?.data?.detail || 'Ошибка при удалении техусловия')
    },
  })

  // Открыть модал для создания
  const handleOpenCreateModal = () => {
    setEditingRecord(null)
    setFileList([])
    form.resetFields()
    setIsModalOpen(true)
  }

  // Открыть модал для редактирования
  const handleOpenEditModal = (record: TechnicalCondition) => {
    setEditingRecord(record)
    form.setFieldsValue({
      received_from: record.received_from,
      description: record.description,
    })
    setFileList([])
    setIsModalOpen(true)
  }

  // Закрыть модал
  const handleCloseModal = () => {
    setIsModalOpen(false)
    setEditingRecord(null)
    form.resetFields()
    setFileList([])
  }

  // Обработка отправки формы
  const handleSubmit = async (values: any) => {
    if (!editingRecord && fileList.length === 0) {
      message.error('Пожалуйста, выберите PDF файл')
      return
    }

    const data: any = {
      received_from: values.received_from,
      description: values.description || '',
    }

    // Добавляем файл только если он выбран
    if (fileList.length > 0 && fileList[0].originFileObj) {
      data.file = fileList[0].originFileObj
    }

    if (editingRecord) {
      updateMutation.mutate({ id: editingRecord.id, data })
    } else {
      createMutation.mutate(data)
    }
  }

  // Обработка удаления
  const handleDelete = (id: number) => {
    deleteMutation.mutate(id)
  }

  // Скачивание файла
  const handleDownload = (record: TechnicalCondition) => {
    window.open(record.file_url, '_blank')
  }

  // Колонки таблицы
  const columns = [
    {
      title: '№',
      key: 'index',
      width: 60,
      render: (_: any, __: any, index: number) => index + 1,
    },
    {
      title: 'PDF файл',
      dataIndex: 'file',
      key: 'file',
      render: (file: string, record: TechnicalCondition) => (
        <Button
          type="link"
          icon={<FilePdfOutlined />}
          onClick={() => handleDownload(record)}
        >
          Открыть PDF
        </Button>
      ),
    },
    {
      title: 'От кого получено',
      dataIndex: 'received_from',
      key: 'received_from',
      render: (text: string) => <Text strong>{text}</Text>,
    },
    {
      title: 'Описание',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
    },
    {
      title: 'Добавил',
      dataIndex: 'created_by_name',
      key: 'created_by_name',
    },
    {
      title: 'Дата добавления',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (date: string) => dayjs(date).format('DD.MM.YYYY HH:mm'),
    },
    {
      title: 'Действия',
      key: 'actions',
      width: 150,
      render: (_: any, record: TechnicalCondition) => (
        <Space>
          <Button
            type="link"
            icon={<DownloadOutlined />}
            onClick={() => handleDownload(record)}
          >
            Скачать
          </Button>
          {canManage() && (
            <>
              <Button
                type="link"
                icon={<EditOutlined />}
                onClick={() => handleOpenEditModal(record)}
              />
              <Popconfirm
                title="Удалить техусловие?"
                description="Это действие нельзя отменить"
                onConfirm={() => handleDelete(record.id)}
                okText="Да"
                cancelText="Нет"
              >
                <Button type="link" danger icon={<DeleteOutlined />} />
              </Popconfirm>
            </>
          )}
        </Space>
      ),
    },
  ]

  return (
    <div>
      <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <Title level={2} style={{ margin: 0 }}>Техусловия</Title>
        {canManage() && (
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={handleOpenCreateModal}
          >
            Добавить техусловие
          </Button>
        )}
      </div>

      <Table
        columns={columns}
        dataSource={technicalConditions || []}
        rowKey="id"
        loading={isLoading}
        pagination={{
          pageSize: 10,
          showSizeChanger: true,
          showTotal: (total) => `Всего: ${total}`,
        }}
      />

      {/* Модальное окно для создания/редактирования */}
      <Modal
        title={editingRecord ? 'Редактировать техусловие' : 'Добавить техусловие'}
        open={isModalOpen}
        onCancel={handleCloseModal}
        onOk={() => form.submit()}
        okText={editingRecord ? 'Сохранить' : 'Добавить'}
        cancelText="Отмена"
        width={600}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleSubmit}
        >
          <Form.Item
            name="file"
            label="PDF файл"
            rules={!editingRecord ? [{ required: true, message: 'Пожалуйста, выберите PDF файл' }] : []}
          >
            <Upload
              accept=".pdf"
              maxCount={1}
              fileList={fileList}
              beforeUpload={(file) => {
                // Проверка типа файла
                if (file.type !== 'application/pdf') {
                  message.error('Можно загружать только PDF файлы')
                  return false
                }

                // Проверка размера (максимум 10 МБ)
                if (file.size > 10 * 1024 * 1024) {
                  message.error('Размер файла не должен превышать 10 МБ')
                  return false
                }

                setFileList([file as any])
                return false // Предотвращаем автоматическую загрузку
              }}
              onRemove={() => {
                setFileList([])
              }}
            >
              <Button icon={<UploadOutlined />}>Выбрать PDF файл</Button>
            </Upload>
            {editingRecord && !fileList.length && (
              <Text type="secondary" style={{ fontSize: '12px', display: 'block', marginTop: '8px' }}>
                Если не выбран новый файл, текущий файл останется без изменений
              </Text>
            )}
          </Form.Item>

          <Form.Item
            name="received_from"
            label="От кого получено"
            rules={[{ required: true, message: 'Пожалуйста, укажите организацию' }]}
          >
            <Input placeholder="Например: Водоканал, Телеком, Электросеть" />
          </Form.Item>

          <Form.Item
            name="description"
            label="Описание (опционально)"
          >
            <TextArea
              rows={4}
              placeholder="Дополнительное описание технического условия"
            />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default TechnicalConditions
